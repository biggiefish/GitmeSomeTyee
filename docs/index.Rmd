---
title: "GitTyee"
author: "Eric V"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: true
    code_folding: "show"
---

A high-level look at trends in catches of Tyee salmon in Campbell River's legendary Tyee Pool All data exploration is being completed for [fun](https://i.giphy.com/media/Cz6TlrRVVyv9S/giphy.webp) and to learn some new tools. There are far more technical ways of examining this data, but they aren't as fun. All results and interpretation are purely speculative. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Prepare Working Environment ----
## Clear workspace ##
rm(list = ls())  

## This code is to fix a bug in R 2023.06.0+421 <https://github.com/rstudio/rstudio/issues/13188>
options(rstudio.help.showDataPreview = FALSE)
getOption("rstudio.help.showDataPreview")

## Load Packages
    library(tidyverse)
    library(tidyr)
    library(dplyr)
    library(zoo)
    library(lubridate)
    library(reshape2)
    library(ggplot2)
    library(readxl)
    library(downloadthis)
    library(knitr)
    library(captioner)

## Define Working Directory ---
#setwd("C:/Users/evogt/R Analysis/EAV/Tyee/")

## Define Input Files
    #1. Catch Data
    catch.dat <- "Data/TyeeCatchData.xlsx"
    
    #2. Escapement Data
    esc.dat <- "Data/Area13Escapement.xlsx"
    
    #3. Flow Data
    q.dat <- "Data/CR_Discharge.xlsx"
    
    #4. Age Class Data
    age.dat <- "Data/CR_AgeClass.xlsx"

## Define Output Locations
    plot.output <- "Plots/"
    model.output <- "Output/"
    
##  
  fig_nums   <- captioner(prefix = "Figure")  
  table_nums <- captioner(prefix = "Table")
    
##__________________________####    
## Load Data ---- 

##* 1. Prep Blank Date Data ---- 
    date_seq <- data.frame(Date = seq(ymd('2002-07-01'), ymd('2022-09-30'), by = 'days')) %>%
                mutate(Month = strftime(Date, format = "%m"),
                       Month = as.numeric(Month)) %>%
                filter(between(Month,7,9))

## * 2. Tyee Catch Data ----
    raw_catch  <- read_excel(catch.dat) # Date, time and size of capture

        ## Format Catch Data Dates ##
        raw_catch <- raw_catch %>% mutate(Date = as.Date(raw_catch$RawDate),
                                          catch_binary = 1) %>%
                                   group_by(Date) %>%
                                   summarise(catch_binary = sum(catch_binary))

        ## Merge with date_sequence
        catch_daily <- left_join(date_seq, raw_catch, by = "Date") %>%
                       mutate(catch_binary = coalesce(catch_binary, 0),  
                              Year = strftime(Date, format = "%Y"),
                              Year = as.numeric(Year),
                              Month = strftime(Date, format = "%m"),
                              Month = as.numeric(Month),
                              Weeknum      = strftime(Date, format = "%V"),
                              Weeknum = as.numeric(Weeknum),
                              catch_binary = coalesce(catch_binary, 0))  
      
        
        ## Calculate Yearly Catches
        catch_yearly <- catch_daily %>% 
                        group_by(Year) %>%
                        summarize(catch_yr.total = sum(catch_binary),
                                  catch_yr.mean  = mean(catch_binary)) %>%
                        ungroup %>%
                        mutate(catch_yrs.mean.total = mean(catch_yr.total),
                               catch_yrs.mean.catch = mean(catch_yr.mean),
                               tyee_cycle4 = as.numeric(rep(1:4, length.out = length(Year))),
                               tyee_cycle5 = as.numeric(rep(1:5, length.out = length(Year)))) 
                                          
        ## Calculate Weekly Catches
        catch_yrwk <- catch_daily %>% 
                      group_by(Year, Weeknum) %>%
                      summarize(catch_yrwk.total = sum(catch_binary)) 

        ## Calculate Weekly Catches
        catch_wk <- catch_daily %>% 
                    group_by(Weeknum) %>%
                    filter(between(Weeknum, 27, 39)) %>%
                    summarize(catch_wk.total = sum(catch_binary)) %>%
                    mutate(catch_wk.mean     = catch_wk.total/21) %>%         # 21 years data from 2002 to 2022
                    ungroup() %>%
                    mutate(catch_wks.mean = mean(catch_wk.mean))
        
         
        ## Merge Catch Data
        catch_dat <- left_join(catch_daily, catch_yearly, by = "Year")
        catch_dat <- left_join(catch_dat, catch_yrwk, by = c("Year", "Weeknum"))
        catch_data <- left_join(catch_dat, catch_wk, by = "Weeknum")

        colnames(catch_data)                               
 
## * 3. Escapement Data ----
        ## Load Data      
        esc_data <- read_excel(esc.dat)
    
        ## Prepare dataset for CR Escapement 
        cr_esc <- esc_data %>% filter(GAZETTED_NAME == "CAMPBELL RIVER",                 # only show data for CR
                                      ANALYSIS_YR >=2002) %>%                             # data for same time period as tyee catch data    
                               mutate(Year          =  as.numeric(ANALYSIS_YR),
                                     Waterbody      =  as.factor(GAZETTED_NAME),
                                     Esc_Count      =  as.numeric(MAX_ESTIMATE),
                                     Esc_Scaled     =  as.numeric(MAX_ESTIMATE/25),
                                     Esc_Mean       =  as.numeric(mean(MAX_ESTIMATE)),
                                     Esc_MeanScaled =  as.numeric(mean(MAX_ESTIMATE/25)),
                                     Species        =  as.factor(SPECIES)) %>%
                               select(Year, Waterbody, Species, Esc_Count, Esc_Scaled, Esc_Mean, Esc_MeanScaled)
        
        
        
## * 4. Flow Data ----
    flow_data <- read_excel(q.dat)

    ## Calculate Weekly Flows    
    flow_data <- flow_data %>% 
                 filter(between(Month, 7, 9), Year >= 2002) %>% 
                        mutate(q.daily = as.numeric(Value),
                               Weeknum = strftime(Date, format = "%V"), #create "Weeknum" column
                               Weeknum = as.numeric(Weeknum),
                               Date    = as.Date(Date),
                               q.5yr.roll.mean = rollmean(q.daily, k = 455, align = "right", fill=NA), # 5yr running flow
                               q.5y.roll.se = rollapply(q.daily, width = 455, FUN = sd, 
                                                        align = "right", fill = NA)/sqrt(455))  # 5yr running SE
              str(flow_data)
    
    q.yearly <- flow_data %>% group_by(Year) %>% 
                                 summarize(q.yr.mean   = mean(Value),
                                           q.yr.se     = sd(Value)/sqrt(n()))
    
    q.monthly <- flow_data %>% group_by(Year, Month) %>% 
                                  summarize(q.yrm    = mean(Value),
                                            q.yrm.se = sd(Value)/sqrt(n()))
    
    q.m       <- flow_data %>% group_by(Month) %>% 
                                  summarize(q.m    = mean(Value),
                                            q.m.se = sd(Value)/sqrt(n()))
      
    q.weekly <- flow_data %>% group_by(Year, Weeknum) %>% 
                                 summarize(q.yrwk    = mean(Value),
                                           q.yrwk.max = max(Value),
                                           q.yrwk.se = sd(Value)/sqrt(n()))
    
    q.wk <-flow_data %>% group_by(Weeknum) %>%
                                summarize(q.wk    = mean(Value),
                                          q.wk.se = sd(Value)/sqrt(n()))
                                
    ## Merge Flow Datasets
    flow.dat <- left_join(flow_data, q.yearly, by = "Year")
    flow.dat <- left_join(flow.dat, q.monthly, by = c("Year","Month"))
    flow.dat <- left_join(flow.dat, q.m,       by = ("Month"))
    flow.dat <- left_join(flow.dat, q.wk,      by = ("Weeknum"))
    flow.data <- left_join(flow.dat, q.weekly, by = c("Year", "Weeknum"))
    
    
## 5. Add age data
    age_data <- read_excel(age.dat)

```

## The Data

This analysis uses the following publicly available data:

1. Annual catch records from the [Tyee Club](https://www.tyeeclub.org/catch-records/>). 
2. Discharge data collected on the Campbell River by the [Water Survey of Canada](https://wateroffice.ec.gc.ca/index_e.html).
3. Annual Chinook Salmon escapement data available in the [DFO NuSEDS database](https://open.canada.ca/data/en/dataset/c48669a3-045b-400d-b730-48aafe8c5ee6).
  

This is certainly an interesting dataset, but it has its limitations. For example, there is no information on effort (# boats per day) and biological data is limited (e.g. size, girth and age of tyees or number of undersized fish captured). 

For now, I have only looked at data back to 2002, as that is the limit of easily accessible Tyee catch data. 

## Tyee Catches per Year  
```{r plot1_tyeecatch, echo = FALSE}
## Prepare Plot
plot1 <- ggplot(catch_data) +
                      geom_bar(aes(x= Year, y = catch_binary, fill = tyee_cycle4), stat = "identity") +
                      geom_hline(aes(yintercept=catch_yrs.mean.total, color = catch_yrs.mean.total), 
                                linetype = "dashed", linewidth = 0.5) +
                      ylab("# Tyee Salmon") +
                      guides(fill = "none", #guide_legend(title = "Tyee Cycle"),
                             color = guide_legend(title = "Mean catches per year", label = FALSE)) + 
                      scale_x_continuous(breaks = seq(2002,2023,2)) +
                      scale_y_continuous(breaks = seq(0, 100, 5)) +
                      theme_bw() +  
                      theme(legend.position = c(0.78, 0.88),
                            legend.box.background = element_rect(colour = "black", linewidth = 1.25, fill = NA)) 
```

```{r tyeecatch.plot, echo=FALSE}
suppressWarnings(print(plot1)) 
```

`r fig_nums("plot1", "Number of Tyee Salmon captured per year.")`


A quick look at `r fig_nums("plot1", display = "cite")` shows:
  1. There is a fairly clear 4-year cycle of relatively higher catches (highlighted with shading).
  2. There has been a consistent decline in the number of Tyee salmon captured per year and that there was a major crash in 2014.
        
```{r include=FALSE}
## Merge escapement data with tyee catch data
cr_data <- left_join(catch_data, cr_esc, by = "Year")
    
cr_yearly <- cr_data %>% mutate(Year = as.numeric(Year)) %>%
                         group_by(Year) %>%
                         select(Year, catch_yr.total, catch_yr.mean, Esc_Scaled, Species, tyee_cycle4)
```

## Tyee Catches Relative to Escapement        
```{r plot2_CR_Esc, echo = FALSE}

## Prepare plot
plot2 <- ggplot(cr_data) +
                geom_bar(aes(x = Year, y = catch_binary, fill = tyee_cycle4), 
                              stat = "identity") +
                geom_line(aes(x = Year, y = Esc_Scaled, linetype = Species), 
                              color = "lightblue", linewidth = 1.2) +
                geom_hline(aes(yintercept = catch_yrs.mean.total, color = catch_yrs.mean.total), 
                              linetype = "dashed", linewidth = 0.5) +
                labs(x = "Year", y = "Number Tyee Captured") + 
                guides(fill =  "none", #guide_legend(title = "Tyee Cycle", label = FALSE),
                       linetype = guide_legend(title = "Escapement", label = FALSE),
                       color = guide_legend(title = "Mean Tyee Catch", label = FALSE)) +
                scale_y_continuous(breaks = seq(0, 100, 5),
                                    sec.axis = sec_axis(~.*25, name = "Escapement")) +  #scale secondary access by x25
                scale_x_continuous(breaks = seq(2002,2022,2)) +            
                theme_bw() +
                theme(legend.direction = "horizontal",
                      legend.position = "bottom")

```

If we look at Escapement trends presented in `r fig_nums("plot2", display = "cite")` , we can see:
      1. There has been a general declining trend in escapement (consistent with regional trends),
      2. Periods of increased escapement correspond with periods of increased Tyee catches, but not always (e.g. 2005, 2017 and             2020). Given the lack of information on effort (e.g. # of boats fishing per day) we cannot tease apart whether the lack of         catches in some years is due to reduction in pressure. 
      3. It is also possible that years with high escapement and low Tyee numbers were due to an increased proportion of smaller            fish returning to the Campbell. Without annual information on age structure I cannot tease this apart.



```{r tyee vs escapement, echo=FALSE}
suppressWarnings(print(plot2))   
```

`r fig_nums("plot2", "Trends in Tyee Salmon captures and Campbell River Chinook Salmon escapement.")`


Publicly accessible information on the age structure of Chinook Salmon in the Campbell River is relatively limited. Data           reported by [Sturham et al. 1999](https://publications.gc.ca/collections/collection_2014/mpo-dfo/Fs97-4-2477-eng.pdf) are          presented in `r table_nums("table1", display = "cite")` and show that most fish returning to the Campbell River are Age 4          (length from 550-949 mm, mean = 780 mm) and Age 5 (length = 700-949 mm, mean = 846 mm).

If additional biological data was available, it would be possible to crudely estimate the number of Tyee salmon returning each year. 



```{r table1prep, include = FALSE}
age_table <- age_data %>% select(Waterbody, Sex, Age, n, Perc.Total.by.Sex, Perc.Total.by.Stream, bin_range, meanFL, SE)


table1 <- knitr::kable(age_table, col.names = c("Waterbody","Sex", "Age", "n", "% of Total <br>(by Sex)", "% of Total <br>(by Stream)", "Size Range <br>(mm)", "Mean Lenght <br>(mm)", "Std. Error"),
             digits = 2,  align=rep('c', 5),
             caption = "Table 1. Size at age of Chinook Salmon captured in Campbell River watershed")
```


```{r, echo = FALSE}
table1
```



## Influence of river flow on catches
Last year there was a lot of speculation that high flows in the Campbell River may have caused fish to move directly into the river rather than staging in the pool. Let's look at flow in the Campbell River to see how 2022 flows compared to previous years. 

```{r plot3-4prep, include = FALSE}
    flow.catch <- left_join(flow.data, catch_data, by = c("Year","Month","Weeknum","Date"))
    
    
    ## Reduce to past 5 years only.                          
    flow.catch <- flow.catch %>%  
                  mutate(catch_scaled    = catch_binary * 7, 
                         q.daily.scaled  = q.daily/20,
                         q.5yr.rm.scaled = q.5yr.roll.mean/20,
                         q.5y.rse.scaled = q.5y.roll.se/20,
                         date.std = case_when(year(Date) >= 0 ~ 'year<-'(Date, 2021),TRUE ~ Date)) ## Set all dates to same year
                                                
    
    flow.catch.2022 <- flow.catch %>% filter(between(date.std, as.Date("2021-07-15"), as.Date("2021-09-15")),
                                               Year  >= 2019,
                                               PARAM == 1)
    
    flow.catch.recent <- flow.catch %>% filter(between(date.std, as.Date("2021-07-15"), as.Date("2021-09-15")),
                                               Year >2006,
                                               PARAM == 1)

plot3 <-    ggplot(flow.catch.2022) +
                 geom_bar(aes(x = date.std, y = catch_scaled, fill = PARAM), stat= "identity", color = "Navy") +
                 geom_line(aes(x = date.std, y = q.daily, linetype = "dashed", color = "Daily")) +
                 geom_line(aes(x = date.std, y = q.5yr.roll.mean, linetype = "twodashed", color = "5-yr Mean")) +
                 geom_text(aes(x = as.Date("2021-07-20"), y = 10, label = str_c("Total Catch = ",catch_yr.total), size = 8)) +
                 labs(x = "Date", y = "Discharge") +
                 scale_x_date(date_breaks = "5 days", date_labels = "%m-%d", minor_breaks = "1 day") +
                 scale_y_continuous(breaks = seq(0, 75, 13),
                                    sec.axis = sec_axis(~./7, name = "Number of Fish")) +  #scale secondary access by x25
                 guides(fill = guide_legend(title = "# Tyee", label = FALSE),
                        linetype = "none",
                        color = guide_legend(title = "Discharge (cms)", label = TRUE),
                        size = "none") +
                 facet_grid(Year~.) +
                 theme_bw() +
                 theme(legend.position = "bottom") 

plot4 <-    ggplot(flow.catch.recent) +
                 geom_bar(aes(x = date.std, y = catch_scaled, fill = PARAM), stat= "identity", color = "Navy") +
                 geom_line(aes(x = date.std, y = q.daily, linetype = "dashed", color = "Daily")) +
                 geom_line(aes(x = date.std, y = q.5yr.roll.mean, linetype = "twodashed", color = "5-yr Mean")) +
                 geom_text(aes(x = as.Date("2021-07-20"), y = 13, label = str_c("Total Catch = ",catch_yr.total), size = 8)) +
                 labs(x = "Date", y = "Discharge (cms)") +
                 scale_x_date(date_breaks = "5 days", date_labels = "%m-%d", minor_breaks = "1 day") +
                 scale_y_continuous(breaks = seq(0, 130, 10),
                                    sec.axis = sec_axis(~./7, name = "Number of Fish")) +  #scale secondary access by x25
                 guides(fill = guide_legend(title = "# Tyee", label = FALSE),
                        linetype = "none",
                        color = guide_legend(title = "Discharge (cms)", label = TRUE),
                        size = "none") +
                 facet_grid(Year~.) +
                 theme_bw() +
                 theme(legend.position = "bottom")  


```


```{r plot3print,  echo = FALSE}
suppressWarnings(print(plot3))  
```

`r fig_nums("plot3", "Catches of Tyee Salmon since 2016 relative to flow in the Campebll River.")`


Well, it's clear that flows in 2022 were higher than past years and higher than mean flows over the past 5-years. But this doesn't mean that is why fewer fish were captured but let's take a closer look at the correlation between flow and capture.

```{r prepare scatter plot, include = FALSE}
flow.catch.scatter <- flow.catch %>% filter(catch_binary == 1) %>%
                                     group_by(format(q.daily, digits = 1)) %>%
                                     mutate(total.catch = sum(catch_binary),
                                            total.catch.ln = log(total.catch),
                                            q.daily.ln     = log(q.daily)) 
library(scales)
plot5 <- ggplot(flow.catch.scatter, aes(x=q.daily, y = total.catch)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 35)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

summary(flow.catch.scatter$total.catch.ln) #1-5
summary(flow.catch.scatter$q.daily.ln) #3-5

## Use this!
plot5.1 <- ggplot(flow.catch.scatter, aes(x=q.daily.ln, y = total.catch)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Log Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()


plot5.2 <- ggplot(flow.catch.scatter, aes(x=q.daily, y = total.catch.ln)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

plot5.3 <- ggplot(flow.catch.scatter, aes(x=q.daily.ln, y = total.catch.ln)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

```

```{r, echo=FALSE}
suppressWarnings(print(plot5))
```

`r fig_nums("plot5", "Relationship between river flow and fish capture")`

`r fig_nums("plot5", display = "cite")` shows a strong negative relationship between discharge and the number of fish that are captured. This is what you would expect, that fish will hold in the pool while flows are low and that they will move into the river when flows are higher and they can safely navigate upstream. However, the fishery occurs during the late summer, when flows are typically low and it is possible that the timing of the fishery has contributed to observed trends. 

Scaling the discharge data improved the fit, and still shows a negative relationship between captures and discharge.
```{r, echo=FALSE}
suppressWarnings(print(plot5.1))
```

`r fig_nums("plot5", "Relationship between the natural log of discharge and fish capture")`


Now we know there is a relationship, lets have a look at some of the older data. 

```{r plot_flow,  fig.dim = c(8,30), echo=FALSE}
suppressWarnings(print(plot4))
```

`r fig_nums("plot4", "Catches of Tyee Salmon since 2007 relative to flow in the Campebll River.")`


