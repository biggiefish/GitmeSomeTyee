---
title: "GitTyee"
author: "Eric"
date: "`r Sys.Date()`"
theme: cerulean
output: 
  html_document:
    fig_caption: true
    code_folding: "show"
    toc: true
    toc_float: true
  
---


```{r link to site, include = FALSE}
"https://biggiefish.github.io/GitmeSomeTyee/"
```

# 1. What is this?
A high-level, very casual, and often self-deprecating look at trends in catches of Tyee salmon in Campbell River's legendary [Tyee Pool](https://goo.gl/maps/4Nb4etqRVjoSSfqSA). All data exploration is being completed for [fun](https://i.giphy.com/media/Cz6TlrRVVyv9S/giphy.webp) and to learn some new tools (namely [R Markdown](https://rmarkdown.rstudio.com/) and [plotly](https://plotly.com/r/)). 

There are far more technical ways of examining this data, but they aren't as much fun - and are frankly hard. This analysis is living and will evolve over time. All results and interpretation are purely speculative and should be considered nothing more than ramblings of a fish nerd. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Prepare Working Environment ----
## Clear workspace ##
rm(list = ls())  

## This code is to fix a bug in R 2023.06.0+421 <https://github.com/rstudio/rstudio/issues/13188>
options(rstudio.help.showDataPreview = FALSE)
getOption("rstudio.help.showDataPreview")

## Load Packages and dependencies. 
list.of.packages <- c("tidyverse",
                      "tidyr",
                      "dplyr",
                      "lubridate",
                      "reshape2",
                      "ggplot2",
                      "readxl",
                      "downloadthis",
                      "knitr",
                      "captioner",
                      "zoo",
                      "gridExtra",
                      "plotly",
                      "htmlwidgets")

  ## Load any missing packags.
    new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
    if(length(new.packages)) install.packages(new.packages)

## Load Packages
    library(tidyverse)
    library(tidyr)
    library(dplyr)
    library(lubridate)
    library(reshape2)
    library(ggplot2)
    library(readxl)
    library(downloadthis)
    library(knitr)
    library(captioner)
    library(zoo)
    library(gridExtra)
    library(plotly)
    library(htmlwidgets)


## Define Working Directory ---
#setwd("C:/Users/evogt/R Analysis/EAV/Tyee/")

## Define Input Files
    #1. Catch Data
    catch.dat <- "Data/TyeeCatchData.xlsx"
    
    #2. Escapement Data
    esc.dat <- "Data/Area13Escapement.xlsx"
    
    #3. All Areas Escapement Data
    all.esc.data <- "Data/Escapement_AllAreas.xlsx"
    
    #4. Flow Data
    q.dat <- "Data/CR_Discharge_1949-2023.xlsx" 
    
    #5. Age Class Data
    age.dat <- "Data/CR_AgeClass.xlsx"
    
    #6. Commercial Catch data
    comm.catch.dat <- "Data/NPAFC_CommercialCatch_21June2022.xlsx"

## Define Output Locations
    plot.output <- "Plots/"
    model.output <- "Output/"
    
##  Set up captioner package calls. 
  fig_nums   <- captioner(prefix = "Figure")  
  table_nums <- captioner(prefix = "Table")
    
##__________________________####    
## Load Data ---- 

##* 1. Prep Blank Date Data ---- 
    date_seq <- data.frame(Date = seq(ymd('2002-07-01'), ymd('2022-09-30'), by = 'days')) %>%
                mutate(Month = strftime(Date, format = "%m"),
                       Month = as.numeric(Month)) %>%
                filter(between(Month,7,9))

## * 2. Tyee Catch Data ----
    raw_catch  <- read_excel(catch.dat) # Date, time and size of capture

        ## Format Catch Data Dates ##
        raw_catch <- raw_catch %>% mutate(Date = as.Date(raw_catch$RawDate),
                                          catch_binary = 1) %>%
                                   group_by(Date) %>%
                                   summarise(catch_binary = sum(catch_binary))

        ## Merge with date_sequence
        catch_daily <- left_join(date_seq, raw_catch, by = "Date") %>%
                       mutate(catch_binary = coalesce(catch_binary, 0),  
                              Year = strftime(Date, format = "%Y"),
                              Year = as.numeric(Year),
                              Month = strftime(Date, format = "%m"),
                              Month = as.numeric(Month),
                              Weeknum = strftime(Date, format = "%V"),
                              Weeknum = as.numeric(Weeknum),
                              catch_binary = coalesce(catch_binary, 0))  
      
        
        ## Calculate Yearly Catches
        catch_yearly <- catch_daily %>% 
                        group_by(Year) %>%
                        summarize(catch_yr.total = sum(catch_binary),
                                  catch_yr.mean  = mean(catch_binary)) %>%
                        ungroup %>%
                        mutate(catch_yrs.mean.total = mean(catch_yr.total),
                               catch_yrs.mean.catch = mean(catch_yr.mean),
                               tyee_cycle4 = as.numeric(rep(1:4, length.out = length(Year))),
                               tyee_cycle5 = as.numeric(rep(1:5, length.out = length(Year)))) 
                                          
        ## Calculate Weekly Catches
        catch_yrwk <- catch_daily %>% 
                      group_by(Year, Weeknum) %>%
                      summarize(catch_yrwk.total = sum(catch_binary)) 

        ## Calculate Weekly Catches
        catch_wk <- catch_daily %>% 
                    group_by(Weeknum) %>%
                    filter(between(Weeknum, 27, 39)) %>%
                    summarize(catch_wk.total = sum(catch_binary)) %>%
                    mutate(catch_wk.mean     = catch_wk.total/21) %>%         # 21 years data from 2002 to 2022
                    ungroup() %>%
                    mutate(catch_wks.mean = mean(catch_wk.mean))
        
         
        ## Merge Catch Data
        catch_dat <- left_join(catch_daily, catch_yearly, by = "Year")
        catch_dat <- left_join(catch_dat, catch_yrwk, by = c("Year", "Weeknum"))
        catch_data <- left_join(catch_dat, catch_wk, by = "Weeknum")

        colnames(catch_data)                               
 
## * 3. Escapement Data ----
        ## Load Data      
        esc_data <- read_excel(esc.dat)
        
        esc.dat2 <- filter(esc_data, ANALYSIS_YR > 2010)
    
        ## Prepare dataset for CR Escapement 
        cr_esc <- esc_data %>% filter(GAZETTED_NAME == "CAMPBELL RIVER",                 # only show data for CR
                                      #ANALYSIS_YR >=2002) %>% # data for same time period as tyee catch data
                                      ANALYSIS_YR >=1990) %>% # data from prior to tyee catch data so we can predict tyee returns.    
                               mutate(Year          =  as.numeric(ANALYSIS_YR),
                                     Waterbody      =  as.factor(GAZETTED_NAME),
                                     esc_count      =  as.numeric(MAX_ESTIMATE),
                                     Esc_Scaled     =  as.numeric(MAX_ESTIMATE/25),
                                     Esc_Mean       =  as.numeric(mean(MAX_ESTIMATE)),
                                     Esc_MeanScaled =  as.numeric(mean(MAX_ESTIMATE/25)),
                                     Species        =  as.factor(SPECIES)) %>%
                               select(Year, Waterbody, Species, esc_count, Esc_Scaled, Esc_Mean, Esc_MeanScaled)
        
        
        
## * 4. Flow Data (Tyee Season) ----
      ## Daily flow Data from 1949 to 2021
      flow_data <- read_excel(q.dat) 
          
      flow.data.all <- flow_data %>% 
                              mutate(Season   
                                        = case_when(
                                              Month >=1 & Month <= 3 ~ "Winter",
                                              Month >=4 & Month <= 6 ~ "Spring",
                                              Month >=7 & Month <= 8 ~ "Summer",
                                              Month >=9 & Month <= 10 ~ "Fall",
                                              Month >=11 & Month <= 12 ~ "Winter")) %>%
                              group_by(Year, Season) %>%
                              mutate(q.peak.season.yr = max(Value),
                                     test.data = as.numeric(1))   

    ## Flow Data Through Tyee Season(July 1 to Sept 30. 2000 to 2022)
      str(flow.data.all)

    flow.data.tyee <- flow.data.all %>% 
                        filter(between(Month,7,9)) %>%
                        mutate(q.daily         = as.numeric(Value),
                               Date            = as.Date(Date),
                               Year            = format(Date, '%Y'),
                               Month           = format(Date, '%m'),
                               Weeknum         = format(Date, format = "%V")) %>%
                        group_by(Year) %>% 
                              mutate(q.yr.mean  = mean(Value, na.rm = TRUE),
                                     q.yr.se = sd(Value, na.rm = TRUE)/sqrt(n())) %>% 
                        ungroup() %>%
                                           
                        group_by(Month) %>%                                              
                              mutate(q.m       = mean(Value, na.rm = TRUE),
                                     q.m.se    = sd(Value, na.rm = TRUE)/sqrt(n())) %>%
                              ungroup() %>%
                                         
                         group_by(Year, Month) %>% 
                              mutate(q.yrm     = mean(Value, na.rm = TRUE),
                                     q.yrm.se  = sd(Value, na.rm = TRUE)/sqrt(n())) %>%
                              ungroup() %>%
                   
                         group_by(Year, Weeknum) %>% 
                              mutate(q.yrwk     = mean(Value, na.rm = TRUE),
                                     q.yrwk.max = max(Value, na.rm = TRUE),
                                     q.yrwk.se  = sd(Value, na.rm = TRUE)/sqrt(n())) %>%
                              ungroup()   %>%      
 
                        group_by(Weeknum) %>%
                              mutate(q.wk       = mean(Value, na.rm = TRUE),
                                     q.wk.se    = sd(Value, na.rm = TRUE)/sqrt(n())) %>%
                              ungroup() %>%
                        mutate(q.5yr.roll.mean = rollmean(q.daily, k = 455, align = "right", fill=NA), # 5yr running flow
                               q.5y.roll.se    = rollapply(q.daily, width = 455, FUN = sd, align = "right", fill = NA)/sqrt(455)) %>%
                        filter(Year > 2001)

## 5. Add age data
    age_data <- read_excel(age.dat)
    
## 6. Salmon Catch Data
    comm.catch.dat <- read_excel(comm.catch.dat) 

    comm.catch <- comm.catch.dat %>% pivot_longer(cols = c(7:103),
                                                  names_to = "Year",
                                                  values_to = "Total.Catch",
                                                  values_drop_na = TRUE) %>%
                                      rename(Area = 'Reporting Area')
```


##    1.1 The data

This analysis uses the following publicly available data:

1) Annual catch records from the [Tyee Club](https://www.tyeeclub.org/catch-records/>). 
2) Discharge data collected on the Campbell River by the [Water Survey of Canada](https://wateroffice.ec.gc.ca/index_e.html).
3) Annual Chinook Salmon escapement data available in the [DFO NuSEDS database](https://open.canada.ca/data/en/dataset/c48669a3-045b-400d-b730-48aafe8c5ee6).
4) Annual catch statistics from the [North Pacific Anadromous Fish Commission](https://npafc.org/statistics/)
5) Area based commercial catch statistics from DFO are [available from 2001 to 2016](https://www.pac.dfo-mpo.gc.ca/stats/smon/index-eng.html) 
6) Straight of Georgia herring [spawn](https://www.pac.dfo-mpo.gc.ca/science/species-especes/pelagic-pelagique/herring-hareng/herspawn/tabsfram-eng.html) and [catch](https://www.pac.dfo-mpo.gc.ca/science/species-especes/pelagic-pelagique/herring-hareng/herspawn/tabcfram-eng.html) data 


This is certainly an interesting dataset, especially given it is the Tyee Club centenary,  but it has its limitations. For example, there is no information on effort (# boats per day) and biological data is limited (e.g. size, girth and age of tyees or number of undersized fish captured). 



# 2. Chinook Salmon


## 2.1 What we* know about Campbell River Chinook? 


(* more like what have other learned about Campbell River Chinook Salmon, I don't know much).


There has been a lot of information collected on Campbell River Chinook Salmon, including from Tyee Salmon captured in the Tyee Pool, however, most of this data is not readily available online. Data that is available (and that I have found) is summarized below. 

**2.1.1 Spawn Timing**

  +   Chinook spawning occurs from late September through early November and peaks in mid-October and that spawners reside in the river for ~12 days. 

**2.1.2 Age Class Structure**

  +   A roughly equal proportion of spawners return to the Campbell River as age-4 and age-5 fish (see Table 1) [Sturham et al. 1999](https://publications.gc.ca/collections/collection_2014/mpo-dfo/Fs97-4-2477-eng.pdf). 
    
  +   However, [Ewart & Anderson,2013](http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf) report that Age-5 fish were dominant in 2012 (61%), with Age-4's accounting for only 37% of the run, and age-3's representing only 2%.
    
**2.1.3 Size-at-Age**

  +   I have not found any measures of individual fish. But binned data from [Sturham et al. 1999](https://publications.gc.ca/collections/collection_2014/mpo-dfo/Fs97-4-2477-eng.pdf) shows that Age-4 fish generally range in size from 550-949 mm (mean ~ 780 mm) and age-5 fish range from 700-949 mm (mean ~ 840 mm). Age-6 fish were identified, but accounted for less than 1% of all fish in the Campbell (n = 1 fish, 930 mm) and Quinsam rivers  

**2.1.4 Fecundity**

  +   [Ewart & Anderson, 2013](http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf) 
  report that female Chinook in the Campbell River in 2012 carried roughly ~5,700, a decrease from the roughly 6,000 eggs 
  typically carried.  

**2.1.5 Juvenile Life History**

  +   Juvenile Chinook Salmon in the Campbell River have been studied intensively since 2015 (e.g. [Thornton et al. 2022](https://www.bchydro.com/content/dam/BCHydro/customer-portal/documents/corporate/environment-sustainability/water-use-planning/vancouver-island/jhtmon-15-Yr-7-2022-07-25.pdf). These data suggests fry emerge in February-March and that nearly all Campbell River Chinook out migrate as Age-0+ juveniles from March through July. Smaller recently emerged Age-0+ fry are dominant and typically captured from March through early May (37 to 52 m). Larger Age-0+ smolts are less common and move out from May through July (64 to 88 mm).
    
**2.1.6 Estimated Juvenile Production**

  +   Estimates of juvenile Chinook production based on numbers of observed spawners have generally been less than numbers 
  trapped  throughout the outmigration period ([Thornton et al. 2022](https://www.bchydro.com/content/dam/BCHydro/customer-portal/documents/corporate/environment-sustainability/water-use-planning/vancouver-island/jhtmon-15-Yr-7-2022-07-25.pdf), which may be due to increased juvenile survival or inaccurate/coarse estimates of fecundity. 

**2.1.7 Estimates of Marine Survival**

  +   Marine survival of unfed fry released from the Quinsam hatchery range from 0.2% to 0.4% (yes, that is less than 1%) ([Ewart & Anderson 2013]( http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf)).  

**2.1.8 Hatchery Influence and Population Status**

  +   [Ewart & Anderson 2013](http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf) report
  that 56% of the otoliths examined from the 2012 return showed no signs of hatchery marking and are assumed wild. The
  remaining 44% are presumed to have originated from instream incubators (31%), seapen released smolts (4%) and Quinsam River
  released smolts (9%). 

```{r table1prep, include = FALSE}
## Prepare data for table
age_table1 <- age_data %>% select(Waterbody, Age, n, bin_min, bin_max, meanFL, SD, SE) %>%
                           #filter(Waterbody == "Campbell River") %>%
                           mutate(Age = as.factor(Age),
                                  meanFL = as.numeric(meanFL),
                                  bin_min = as.numeric(bin_min),
                                  bin_max = as.numeric(bin_max))

  age_table1 <- age_table1 %>% dplyr::group_by(Waterbody, Age) %>%
                                summarize(n = sum(n),
                                          bin_min = min(bin_min),
                                          bin_max = max(bin_max),
                                          mean = mean(meanFL)) %>%
                                mutate('% of Total' = prop.table(n)*100,
                                       size_range = paste(bin_min, "-", bin_max)) %>%
                                select(Waterbody, Age, n, '% of Total',size_range, mean, )
                                
  
table1 <- knitr::kable(age_table1, col.names = c("Waterbody", "Age", "n", "% of Total", "Size Range <br>(mm)", "Mean Lenght <br>(mm)"),
             digits = 1,  align=rep('c', 5),
             caption = "Table 1. Size at age of Chinook Salmon captured in Campbell River watershed from [Sturham et al. 1999](https://publications.gc.ca/collections/collection_2014/mpo-dfo/Fs97-4-2477-eng.pdf)")
```

```{r table1, echo = FALSE}
table1
```
   
## 2.2 What else do we know about current Chinook Salmon trends?

**2.2.1 They are decreasing in size and age at maturity** 

  +   [Ohlberger et al. 2018](https://onlinelibrary.wiley.com/doi/full/10.1111/faf.12272) have shown that there is a reduction in the proportion of older age classes throughout most regions of the East Pacific and that length-at-age of older fish has decreased while length-at-age of smaller fish has increased.
  +   [Malick et al. 2023](https://onlinelibrary.wiley.com/doi/abs/10.1111/faf.12738) compiled 3 decades worth of broodstock data from 43 hatcheries to examine trends in fecundity. They found significant changes in both fecundity and length, with the greatest drop in fecundity occurring over the past decade. Interestingly, they also estimate that a 1 mm reduction in length results in ~7.8 few eggs per female.   
  +   [Oke et al. 2020](https://www.nature.com/articles/s41467-020-17726-z) state that relative to salmon maturing before 1990, adult Chinook salmon now produce 16% fewer eggs, transport 28% less nutrients and have lost 21% of their fisheries value.  

   
**2.2.2 Survival rates have collapsed and returns are decreasing**

  +   [Welch et al. 2018](https://onlinelibrary.wiley.com/doi/epdf/10.1111/faf.12514) used coded-wire tag data to look at large scale patterns of Chinook salmon survival. This data demonstrates that survival collapsed over the past half century by a factor of ~3 and is currently ~1% in many regions (consistent with estimates available for the Campbell). Survival in relatively pristine and undeveloped regions (e.g. Northern BC and Alaska) was comparable to areas with extensive water management and land development that were previously considered to have poorest survival (e.g. Columbia River). The authors suggest the widespread trends in survival may be evidence that marine conditions are more influential than local factors (e.g. freshwater habitat). 
  
  +   Similar trends have been observed in other species. For example, [Price et al. 2021](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2664.13835) found a 69% reduction in wild Sockeye salmon returns (though overall returns are comparable to historic levels due to intensive enhancement); that population diversity has decreased by ~70%, and; that life history diversity has shifted with populations now migrating from freshwater earlier and remaining at sea for longer. 
    
**2.2.3 Enhancement levels have never been higher**

  +   [Ruggerone & Irvine 2018](https://afspubs.onlinelibrary.wiley.com/doi/full/10.1002/mcf2.10023) show that intensive enhancement has resulted in the greatest abundance of salmon in the ocean than ever before (specifically pink, sockeye and chum) and that marine carrying capacity may have been reached within recent decades.         
  +   [Nelson et al. 2019](https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecs2.2922) present evidence that hatchery practices have altered size and time that juveniles are released and have reduced diversity of life history traits (e.g. size, age and timing of smoltification). The authors argue that current enhancement practices may release fish at a time and size that is preferred by predators (e.g. all fish being released at same time and size and are easy pickings for large aggregations of predators).
    
**2.2.4 I am not the only person who doesn't understand what is going on **

  +   [Beamish 2022](https://academic.oup.com/icesjms/article/79/4/1005/6550345) emphasizes that due to the large number of juvenile salmon in the ocean and overall poor survival, any small change in survival can results in major changes in adult abundance. Unfortunately, we don't understand what is causing those small changes in survival in the marine environment and need a better understanding of biologically based mechanisms linking climate change to salmon abundance.


# 3. Let's look at the Tyee catch data!
So, let's begin by having a look at the catch data from the Tyee pool and seeing how catches fluctuate relative to Chinook Salmon escapement in the Campbell River.
```{r plot1_prep_tyeecatch, include=FALSE}
## Prepare Plot
catch.data.yearly <- catch_data %>% 
                          group_by(Year, tyee_cycle4) %>%
                          summarize(Total.Catch = mean(catch_yr.total),
                                    Overall.Mean.Catch = mean(catch_yrs.mean.total)) %>%
                          mutate(Year = as.factor(Year))
                                      
plot1 <- ggplot(catch.data.yearly) +
                      geom_col(aes(x= Year, y = Total.Catch, fill = tyee_cycle4)) + 
                      geom_hline(aes(yintercept=Overall.Mean.Catch, color = Overall.Mean.Catch), 
                                linetype = "dashed", linewidth = 0.5) +
                      labs(y = "# Tyee Salmon", x = "") +
                      guides(fill = "none", #guide_legend(title = "Tyee Cycle"),
                             color = guide_legend(title = "Mean catches per year", label = FALSE)) +
                      # scale_x_discrete(breaks = seq(2002,2023,2)) +
                      # scale_y_discrete(breaks = seq(0, 100, 5)) +
                      theme_bw() +
                      theme(legend.position = c(0.78, 0.88),
                            legend.box.background = element_rect(colour = "black", linewidth = 1.25, fill = NA))

#ggplotly(plot1, tooltip = c("Year", "Total.Catch"))

```



```{r plot1_tyeecatch, include = FALSE, fig.width=8, fig.height=5}

#suppressWarnings(ggplotly(plot1, tooltip = c("Year", "Total.Catch")))

# **`r fig_nums("plot1", "Number of Tyee Salmon captured per year since 2002.")`**

#suppressWarnings(print(plot1)) 
```



```{r plot2_prep_tyee.v.escapement, include=FALSE}
## Filter escapement data.... 
cr_esc2 <- cr_esc %>% filter(Year >=2002)

## Merge escapement data with tyee catch data
cr_data <- left_join(catch_data, cr_esc2, by = "Year")
    
cr_yearly <- cr_data %>% filter(Year < 2022) %>%
                         group_by(Year, tyee_cycle4) %>%
                         summarize(Total.Catch        = mean(catch_yr.total),
                                   Overall.Mean.Catch = mean(catch_yrs.mean.total),
                                   Escapement         = mean(Esc_Scaled)) %>%
                         mutate(Year = as.numeric(Year),
                                Data.Type = "Escapement") 

plot2 <- ggplot(cr_data) +
                geom_bar(aes(x = Year, y = catch_binary, fill = tyee_cycle4),
                              stat = "identity") +
                geom_line(aes(x = Year, y = Esc_Scaled, linetype = Species),
                              color = "lightblue", linewidth = 1.2) +
                geom_hline(aes(yintercept = catch_yrs.mean.total, color = catch_yrs.mean.total),
                              linetype = "dashed", linewidth = 0.5) +
                labs(x = "Year", y = "Number Tyee Captured") +
                guides(fill =  "none",
                       linetype = guide_legend(title = "Escapement", label = FALSE),
                       color = guide_legend(title = "Mean Tyee Catch", label = FALSE)) +
                scale_y_continuous(breaks = seq(0, 100, 5),
                                    sec.axis = sec_axis(~.*25, name = "Escapement")) +  #scale secondary access by x25
                scale_x_continuous(breaks = seq(2002,2022,2)) +
                theme_bw() +
                theme(legend.direction = "horizontal",
                      legend.position = "bottom")

## Figure for plotly
## Secondary Y axis does not work well in plotly.
# plot2.1<- ggplot(cr_yearly, aes(x = Year)) +
#                       geom_col(aes(y = Total.Catch, fill = tyee_cycle4)) +
#                       geom_line(aes(y = Escapement, linetype = Data.Type), 
#                                 color = "lightblue", linewidth = 1.2) +
#                       geom_hline(aes(yintercept = Overall.Mean.Catch, color = Overall.Mean.Catch), 
#                                 linetype = "dashed", linewidth = 0.5) +
#                       labs(y = "# Tyee Salmon", x = "") +
#                       guides(linetype = "none",
#                              fill = "none",
#                              color = guide_legend(title = "Mean catches per year", label = FALSE)) +
#                       scale_x_discrete(breaks = seq(2002,2023,2)) +
#                       scale_y_discrete(breaks = seq(0, 100, 5)) +
#                       theme_bw() +
#                       theme(legend.position = c(0.78, 0.88),
#                             legend.box.background = element_rect(colour = "black", linewidth = 1.25, fill = NA))

```

```{r plot2_tyee.v.escapement, echo=FALSE}

## ggplot figure
suppressWarnings(print(plot2))

## plotly figure
    #suppressWarnings(ggplotly(plot2.1, tooltip = c("Year","Total.Catch", "Escapement", "Overall.Mean.Catch")))   
```

**`r fig_nums("plot2", "Trends in Tyee Salmon captures and Campbell River Chinook Salmon escapement.")`**



A quick look at Tyee catches (blue vertical bars) in `r fig_nums("plot2", display = "cite")` shows:

1) There is a fairly clear 4-year cycle of relatively higher catches (highlighted with shading). Which is interesting, and raises lots of questions...
2) There has been a consistent decline in the number of Tyee salmon captured per year.
3) There was a major crash or failure in 2014. 

If we look at Escapement data (blue line) shown in `r fig_nums("plot2", display = "cite")` , we can see:

1) There has been a general declining trend in escapement (consistent with regional trends),
2) Periods of increased escapement correspond with periods of increased Tyee catches, but not always (e.g. 2005, 2017 and 2020). Given the lack of information on effort (e.g. # of boats fishing per day) we cannot tease apart whether the lack of catches in some years is due to reduction in pressure. 
3) It is also possible that years with high escapement and low Tyee numbers were due to an increased proportion of smaller fish returning to the Campbell. Without annual information on age structure I cannot tease this apart.

Now, lets see when fish are most frequently captured throughout the season, and if there has been a change over time.


```{r daily.decadal.tyee.prep, include = FALSE}
colnames(catch_data)
str(catch_data)

daily.decadal.catch <- catch_data %>% 
                            mutate(decade   = format(floor_date(Date, years(10)), '%Y'),             ## calculate decade
                                   date.std = case_when(year(Date) >= 0 ~ 'year<-'(Date, 2021))) %>%  #Set all dates to same year
                            group_by(decade, date.std) %>%
                            summarize(catch = sum(catch_binary))

colnames(daily.decadal.catch)
str(daily.decadal.catch)

                          
daily.decadal.catch.plot <- ggplot(daily.decadal.catch) +
                                geom_col(aes(x= date.std, y = catch, fill = decade)) +
                                labs(x = "", y = "# Tyees Captured") +
                                scale_x_date(date_minor_breaks = "1 day", date_breaks = '1 week', 
                                             date_labels = '%b-%d', 
                                             limits = c(as.Date("2021-07-01"), as.Date("2021-09-15"))) +
                                # scale_y_discrete(breaks = seq(0, 30, 5)) +
                                guides(fill = guide_legend(title = "Decade")) +
                                theme_bw() +
                                theme(axis.text.x = element_text(angle = 45, vjust = 1.1, hjust = 1)) 
                                
daily.decadal.catch.plot
                        
                              

```
```{r daily.decadal.tyee.plot, echo=FALSE}

## ggplot figure
suppressWarnings(print(daily.decadal.catch.plot))

## plotly figure
    suppressWarnings(ggplotly(daily.decadal.catch.plot, tooltip = c("Decade", "Date","Total Catch")))   
```

**`r fig_nums("daily.decadal.catch", "Total fish captured by date and decade")`**

HEY! Who let someone register a Tyee in the first week of July!? This plot will become a lot more interesting once I can get my hands on some historical data. But for now, we can see:
  +   People either do not fish, or do not catch fish before late July/early August.
  +   Peak catches occur in mid to late August. 
  




## 3.1. What could be affecting returns and catches?
At it's most basic level, there are four things that are likely affecting catches of Tyee salmon (in reality, there are many many many many many more.


**3.1.1. Juvenile recruitment**

* This is determined by the number of eggs that are deposited (for easy math, lets say females account for 50% of escapement, that each one deposits 4000 eggs and that egg to fry survival is 10%). We will assume that fish that survive to fry will enter the sea. Hydrometric data on the Campbell is available back to 1949 and it is likely that extreme high or low flow events (e.g. greater than 300 cms, less than ??50 cms??) during the incubation/rearing periods (maybe November through March) will reduce juvenile recruitment.

**3.1.2. Marine survival and productivity**

* This is way too complicated for right now. Let's feel warm and fuzzy by assuming survival and productivity are stable (side note, they arent!). But if we don't do this we can't assume that proportions calculated from Sturham et al. are representative of current returns (unfortunately recent evidence shows this assumption is wrong and that fish are decreasing in size, so there are likely fewer Tyee returning now than in previous years). 
  
**3.1.3. Fishing effort and catchability **

  * For now, I am going to assume effort (# of boats fishing per tide/day) is constant and that catchability (percent of Tyees present that are captured) are stable. In reality, effort has likely decreased over time (especially since 2014) and catchability has likely increased as peoples knowledge, skill and fishing technology have improved over time (not everyone though, I still suck). Either way, without some hard data it is hard to much with this.

**3.1.4. Fishing Conditions **

  * No question that fewer fish will be captured during seasons with poor fishing conditions (e.g. very windy, lots of rain). It is also possible that fish behaviour will change in response to river conditions. Certainly there was a lot of speculation that high flows during the 2022 Tyee season contributed to record low catches.  
  

# 4. So, what can we look at? 

Off the top of my head there are two ways we can approach this:

1.) We can look at what factors influenced how many fish were available for capture in the Tyee pool (i.e. how historic 
  conditions may have contributed to observed captures), and/or;
  
2.) We can look at what factors influenced how returning fish were captured (i.e. conditions during the fishing season)

## 4.1 How Historic Conditions Influenced Captures

We can ***VERY CRUDELY*** estimate the number of salmon that should return to the Campbell River if we make a couple of big assumptions:

  +   Fecundity is ~5,700 eggs per female ([Ewart & Anderson, 2013](http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf) 
  +   Sex ratios are 60:40 female to male using [Sturham et al. 1999](https://publications.gc.ca/collections/collection_2014/mpo-dfo/Fs97-4-2477-eng.pdf)) data for Campbell River)
  
  +   Egg-to-fry survival is approximately 0.1, can't recall where this number came from but its commonly used as a measure of egg-to-fry survival of wild fish (compared to 0.9 for hatchery reared fish). Give results from [Thornton et al. 2022](https://www.bchydro.com/content/dam/BCHydro/customer-portal/documents/corporate/environment-sustainability/water-use-planning/vancouver-island/jhtmon-15-Yr-7-2022-07-25.pdf) it is likely that egg-to-fry survival in the Campbell is higher.
  
  +   Marine survival (smolt to adult)  is approximately 0.003 ([Ewart & Anderson, 2013](http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf)
  
  +   7.9% of fish will return as Age-3, 44.7% of fish will return as Age-4 fish, 46.1% will return as Age-5 fish and 1.3% will return as Age-6 fish.
  
We can expand this to estimate the number of Tyee salmon that will return if we make even more assumptions! 
  
  +   For fun, let's assume all fish > 900 mm are Tyee Salmon (I know girth is important too, but I dont have girth data) and using the [Sturham et al. 1999](https://publications.gc.ca/collections/collection_2014/mpo-dfo/Fs97-4-2477-eng.pdf)) data as a rough guide I will assume that 10% of Age-4 male adults are >900 mm, 15% of Age-5 fish (males and females) are >900 mm and 85% of Age-6 fish are >900 mm.
  
If we run these numbers, each female will generate `r format(5700*0.1*.003, digits = 2)` offspring, of which `r format((5700*0.1*0.003*0.079), digits = 2)` will be Age-3, `r format((5700*0.1*.003*.447), digits = 2)` will be Age-4, `r format((5700*0.1*.003*0.461), digits = 2)` will be Age-5 and `r format((5700*0.1*.003*.013), digits = 2)` will be Age-6. Furthermore, each female will produce `r format(((57000.1**.003*.447*.4*.15) + (5700*0.1*.003*0.461*.35) + (5700*0.1*.003*.013*.85)),digits = 2)`  Tyee salmon. *Let's take a moment to remember that these assumptions are terrible. Larger fish are more likely to produce larger fish, so in reality some fish will produce a decent number of Tyee and others will produce none. But let's keep it simple for now and assume every fish is able to make an equal number of Tyees*

Based on this, each female should produce `r 5700*0.1*.003` offspring that return to spawn. Which is less than ideal. 


```{r predicted.returns.data.prep0.1fry, include= FALSE}
## Define assumptions
      fecundity <- 5700 # typically around 6000 for CR, http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf
      perc.female <- 0.6  # 60% of fish are females
      egg.to.fry <- 0.1 
      fry.to.smolt <- 0.2
      marine.surv <- 0.003 #marine survival reported as 0.002 to 0.004 by  http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf 
      perc.male <- 0.4                 # 40% of fish are male
      Age3 <- 0.079
      Age4 <- 0.447               # 44.7% of fish are Age-4
      Age5 <- 0.461               # 46.1% of fish are Age-5
      Age6 <- 0.013               #  1.3% of fish are Age-6
      Tyee.Age3m.prop   <- 0      # No Age-3 males are Tyee.
      Tyee.Age4m.prop   <- 0.15   # 10% of Age-4 males are Tyee - MADE UP NUMBER!
      Tyee.Age5mf.prop  <- 0.35   # 15% of all Age-5 fish are Tyee - MADE UP NUMBER!
      Tyee.Age6mf.prop  <- 0.85   # 100% of all Age-6 fish are Tyee - MADE UP NUMBER!
      
## Calculate Ratios
      ratio.Age4.tyee <- perc.male * Age4 * Tyee.Age4m.prop # multiply this by annual escapement to calculate # Age-4 males that are tyees.
      ratio.Age5.tyee <- Age5 * Tyee.Age5mf.prop # multiply this by annual escapement to calculate # Age-5 fish that are tyees.
      ratio.Age5.tyee <- Age6 * Tyee.Age6mf.prop # multiply this by annual escapement to calculate # Age-5 fish that are tyees.

      
## Estimate number of fish predicted to return from each age class based on historic escapement.       
pred.fish <- cr_esc %>% mutate(brood.yr     = Year,
                               pred.fish    = esc_count * perc.female *fecundity *          # total number of fish that will be produced based on 
                                              egg.to.fry * marine.surv,  #fry.to.smolt *      escapement count.
                               Age3_Yr      = Year+3,
                               Age3_returns = Age3*pred.fish,                               # number of produced fish that will return in 3 years.
                               Age3_tyee    = Age3_returns * perc.male * Tyee.Age3m.prop,
                               Age4_Yr      = Year+4,
                               Age4_returns = Age4*pred.fish,
                               Age4_tyee    = Age4_returns * perc.male * Tyee.Age4m.prop,
                               Age5_Yr      = Year+5,
                               Age5_returns = Age5*pred.fish,
                               Age5_tyee    = Age5_returns * Tyee.Age5mf.prop,
                               Age6_Yr      = Year+6,
                               Age6_returns = Age6*pred.fish,
                               Age6_tyee    = Age6_returns * Tyee.Age6mf.prop)


## Estimate total number of Tyee expected to return in each year.
pred.returns <- pred.fish %>% select(brood.yr, esc_count,pred.fish,Age3_Yr, Age4_Yr, Age5_Yr,Age6_Yr,Age3_returns, 
                                     Age4_returns,Age5_returns,Age6_returns, Age3_tyee, Age4_tyee, Age5_tyee, Age6_tyee) %>%
                              pivot_longer(-c(brood.yr, esc_count, pred.fish),
                                                names_to = c("Var", ".value"),
                                                names_sep = "_") %>%
                              rename("returning.ageclass"   = "Var",
                                     "return.year"          = "Yr",
                                     "returning.fish"       = "returns",
                                     "returning.tyee"       = "tyee")

## Summarize predicted returns.
pred.returns2 <- pred.returns %>% 
                              group_by(return.year) %>%
                              summarize(esc_count            = mean(esc_count),
                                        total.pred.return = sum(returning.fish),         # number fish returning based on age.classes
                                        total.pred.tyee = sum(returning.tyee),
                                        total.pred.returns   = mean(pred.fish), #) %>%
                                        Age3.fish = Age3 * total.pred.returns,
                                        Age4.fish = Age4 * total.pred.returns,
                                        Age5.fish = Age5 * total.pred.returns,
                                        Age6.fish = Age6 * total.pred.returns,
                                        Age3.tyee = Age3.fish * 0,
                                        Age4.tyee = Age4.fish * perc.male * Tyee.Age4m.prop,
                                        Age5.tyee = Age5.fish * Tyee.Age5mf.prop,
                                        Age6.tyee = Age6.fish *Tyee.Age6mf.prop) %>%
                              filter(return.year >= 1996)
```

```{r original.predicted code.OLD.DO.NOT.USE, include = FALSE}
# pred.tyee <- pred.fish %>% select(brood.yr, esc_count,pred.fish,Age3_Yr, Age4_Yr, Age5_Yr,Age6_Yr,Age3_tyee, 
#                                      Age4_tyee,Age5_tyee,Age6_tyee) %>%
#                               pivot_longer(-c(brood.yr, esc_count, pred.fish),
#                                                 names_to = c("Var", ".value"),
#                                                 names_sep = "_") %>%
#                               rename("returning.ageclass"   = "Var",
#                                      "return.year"          = "Yr",
#                                      "returning.tyee"       = "tyee") %>%
#                               group_by(return.year) %>%
#                               summarize(esc_count            = mean(esc_count),
#                                         total.returning.fish = sum(returning.fish),
#                                         total.pred.tyee      = mean(pred.fish)) %>%
#                               mutate(Age3.fish = Age3 * total.pred.tyee,
#                                      Age4.fish = Age4 * total.pred.tyee,
#                                      Age5.fish = Age5 * total.pred.tyee,
#                                      Age6.fish = Age6 * total.pred.tyee)
# 
# pred.tyee <- pred.fish %>% select(esc_count,pred.fish,Age4_Yr, Age5_Yr,Age6_Yr,Age4_tyee,Age5_tyee,Age6_tyee) %>%
#                                   pivot_longer(-c(esc_count, pred.fish),
#                                                 names_to = c("Var", ".value"),
#                                                 names_sep = "_") %>%
#                                   rename("Returning.AgeClass"   = "Var",
#                                          "Return.Year"               = "Yr",
#                                          "Tyee.Total"         = "tyee") %>%
#                                   group_by(Year) %>%
#                                   summarize(esc_count            = mean(esc_count),
#                                             Total.Returning.Tyee = sum(Tyee.Total),
#                                             Total.Pred.Returns   = mean(pred.fish)) %>%
#                                   mutate(Return.Year = as.numeric(Return.Year))
 
```

                                        
```{r, predicted.age.class.plot, include = FALSE}
pred.jnk1 <- pred.returns %>% select(brood.yr,esc_count,pred.fish) %>%
                               group_by(brood.yr) %>%
                               summarize(esc_count = mean(esc_count),
                                         pred.fish = mean(pred.fish)) %>%
                               rename(Year = brood.yr)

pred.jnk2 <- pred.returns %>% select(return.year, returning.ageclass, returning.fish) %>%
                               group_by(return.year, returning.ageclass) %>%
                               summarize(returning.fish = sum(returning.fish)) %>%
                               rename(Year = return.year)

pred.jnk3 <- pred.returns %>% select(return.year, returning.tyee) %>%
                               group_by(return.year) %>%
                               summarize(returning.tyee = sum(returning.tyee)) %>%
                               rename(Year = return.year)
                              
pred.jnk4 <- left_join(pred.jnk1, pred.jnk2, by = c("Year")) %>% filter(Year >1995)


pred.jnk5 <- left_join(pred.jnk4, pred.jnk3, by = c("Year"))
         
pred.jnk6 <- catch_data %>% select(Year, catch_yr.total) %>%
                            group_by(Year) %>%
                            summarize(catch_yr.total = mean(catch_yr.total))

pred.plot.dat <- left_join(pred.jnk5, pred.jnk6, by = "Year") %>%
                          mutate(catch_yr.total = coalesce(catch_yr.total, 0))
colnames(pred.plot.dat)

# pred.long.dat <- pred.plot.dat %>% pivot_longer(-c(Year, returning.fish, returning.ageclass)) # THIS DOESNT WORK

pred.age.class.plot <- ggplot(pred.plot.dat, aes(x = Year)) +
                          geom_col(aes(y = returning.fish, fill = returning.ageclass)) +
                          geom_line(aes(y = esc_count, color = "Escapement"), linewidth = 1) +
                          geom_line(aes(y = returning.tyee, color = "Total Predicted Tyee"), linewidth = 1) +
                          geom_line(aes(y = catch_yr.total, color = "Tyee Captured"), linewidth = 1) +
                          scale_color_manual(name = '# Fish', values = c("Escapement" = 'darkblue', 
                                                                         "Total Predicted Tyee"  = 'maroon',
                                                                         "Tyee Captured"   =  'hotpink')) +
                          scale_x_continuous(limits = c(1996,2021)) +
                          labs(y = "# Tyee Salmon", x = "") +
                          guides(fill = guide_legend(title = "Predicted Returns \n by Age Class"),
                                 linewidth ="none") +
                          scale_y_continuous(breaks = seq(0, 1800, 200)) +
                          theme_bw() 
                          # theme(legend.position = c(0.78, 0.88),
                          #       legend.box.background = element_rect(colour = "black", linewidth = 1.25, fill = NA))
```



```{r pred.age.class.plot, echo = FALSE}
## ggplot figure
suppressWarnings(print(pred.age.class.plot))

## plotly figure
    #suppressWarnings(ggplotly(pred.age.class.plot), tooltip = c("Year","returning.fish", "returning.ageclass", "esc_count", "returning.tyee")))   
```

**`r fig_nums("pred.age.class.plot", "Predicted returns by age-class relative to measured escapement, assuming 10% egg to fry survival.")`**

Well that's interesting. There are periods when my predicted returns closely align with actual escapement (most closely from 2003 to 2007, but my values are comparable from 2003 to 2010). This suggests my estimates may not be WAY off but does not confirm they are correct. Other notes:

  +   Also clearly periods when my predictions are off! Most notably from 1998 to 2002, 2011-2012, **2014** and 2019 to 2022.
  +   There are number of years where something appears to have happened and fish simply did not return (2005, 2011, 2014).
  +   There are also years where something positive appears to have happened and far more fish than expected returned to the river (1999 to 2001, 2020).

How does this change if we increase egg-to-fry survival to 0.2? 


I wonder how my predicted tyee returns align with actual tyee captures. 


```{r predicted.returns.plot.prep, include = FALSE, eval = FALSE}

## Join Total Predicted Tyee w. Summarized Tyee Catch data                                           
total.pred.tyee2 <- left_join(total.pred.tyee, cr_data.yr, by = "Year") %>% 
                                       filter(Year >2001)  

summary(total.pred.tyee$Tyee.Total.Predicted)


## need cr_data 
str(total.pred.tyee2)
plot66 <- ggplot(total.pred.tyee2) +
                 geom_bar(aes(x = Year, y = catch_yr.total, alpha = 0.3, fill = 'Total Tyee Catch'), 
                               stat = "identity") +
                 geom_bar(aes(x = Year, y = Tyee.Total.Predicted, alpha = 0.3, fill = 'Predicted Tyee Returns'), 
                              stat = 'identity') +
                # geom_bar(aes(x = Year, y = catch_yr.total, fill = tyee_cycle4, alpha = 0.8), 
                #                stat = "identity") +
                # geom_bar(aes(x = Year, y = Tyee.Total.Predicted, fill = 'Total Predicted Tyee', alpha = 0.3), 
                #               stat = 'identity') +
                geom_line(aes(x = Year, y = Esc_Scaled, linetype = Species), 
                              color = "lightblue", linewidth = 1.2) +
                geom_hline(aes(yintercept = catch_yrs.mean.total, color = catch_yrs.mean.total), 
                              linetype = "dashed", linewidth = 0.5) +
                labs(x = "", y = "Number Tyee Captured") + 
                guides(fill =  guide_legend(title = "", label = TRUE),
                       linetype = guide_legend(title = "Escapement", label = FALSE),
                       color = guide_legend(title = "Mean Tyee Catch", label = FALSE),
                       alpha = "none") +
                scale_y_continuous(breaks = seq(0, 100, 5),
                                    sec.axis = sec_axis(~.*25, name = "Escapement")) +  #scale secondary access by x25
                scale_x_continuous(breaks = seq(2002,2022,2)) +            
                theme_bw() +
                theme(legend.direction = "horizontal",
                      legend.position = "bottom")

```


```{r plot.predictred.returns,  echo = FALSE, eval = FALSE}
suppressWarnings(print(plot66))  
```

**`r fig_nums("plot66", "Comparison of catches of Tyee Salmon, predicted returns of Tyee Salmon and annual Chinook Salmon escapement counts.")`**

Well, even though my estimates are clearly wrong, this is still interesting. There is a fairly drastic shift in predicted returns that coincides with the crash in 2014. Prior to the crash, predicted returns are consistently underestimated (`r format((8/11)*100, digits = 1)`% of years are less than actual catches) whereas after the crash predicted Tyee returns are greater than total tyee catches in all but one year. Not sure exactly what this means, or how to interpret it, but I think its worth considering:

  +   Only a proportion of all returning Tyees are captured each year. If all Tyee salmon were captured each year, we would be actively selecting 
      against large fish and it would be reasonable to expect to see a continuous decline in the total number of Tyees returning each year. So,          based on this logic (and my personal observation of tyees on the spawning ground), the predicted Tyee returns should always be greater than 
      total catches.  
  +   The formula and values used to estimate predicted returns of tyee salmon do not change. If we assume there is no 
      change in catchability and that the number of Tyees captured in the pool is a representation of the actual number of Tyee salmon
      that return to the river there appears to have been a dramatic reduction in the number or proportion of Tyee salmon in 2014. Given low             escapement in 2014, it is most likely a poor return rather than a reduced proportion of Tyee.
  +   Additionally, the figure shows that my formula and estimates are way off - which is not surprising as they were 
      very crude! This is most apparent in the years prior to the 2014 crash, but suggests predictions after the crash are 
      also off too.     

So, what happened in 2014!? Did runs crash everywhere? Let's have a look at escapement in other systems in the area. 

```{r, escapement comparison, include=FALSE}
unique(esc_data$GAZETTED_NAME)
esc.plot.dat <- esc_data %>% filter(GAZETTED_NAME %in% c("ARTLISH RIVER","BEDWELL RIVER", "BURMAN RIVER", "CAMPBELL RIVER", "COWICHAN RIVER", 
                                                     "ENGLISHMAN RIVER","GOLD RIVER", "LITTLE QUALICUM RIVER","NIMPKISH 
                                                     RIVER", "QUALICUM RIVER", "QUINSAM RIVER", "SALMON RIVER")) %>% 
                          mutate(Year = as.numeric(ANALYSIS_YR),
                                 Stream = as.factor(GAZETTED_NAME),
                                 Area   = recode(as.factor(GAZETTED_NAME),
                                                 'ARTLISH RIVER'         = "West Coast VI", 
                                                 'BEDWELL RIVER'         = "West Coast VI",
                                                 'BURMAN RIVER'          = "West Coast VI",
                                                 'GOLD RIVER'            = "West Coast VI",
                                                 'CAMPBELL RIVER'        = "East Coast VI",
                                                 'COWICHAN RIVER'        = "East Coast VI",
                                                 'ENGLISHMAN RIVER'      = "East Coast VI", 
                                                 'LITTLE QUALICUM RIVER' = "East Coast VI",
                                                 'NIMPKISH RIVER'        = "East Coast VI",
                                                 'QUALICUM RIVER'        = "East Coast VI",
                                                 'QUINSAM RIVER'         = "East Coast VI",
                                                 'SALMON RIVER'          = "East Coast VI")) %>%
                          group_by(Area, Stream, Year) %>%
                          summarize(Count =sum(MAX_ESTIMATE)) %>%
                          filter (Year > 2000)



str(esc.plot.dat)
plot.esc <- ggplot(esc.plot.dat, aes(x= Year, y = Count))+
            geom_line(aes(color = Stream), linewidth = 0.4) +
            labs(x = "", y = "# Spawning Chinook") +
            scale_x_continuous(breaks = seq(2000, 2020, by = 2)) +   
            geom_vline(xintercept = 2014, linewidth = 5, color = 'gray', alpha = 0.2) +
            theme_bw() +
            theme(legend.position = "bottom") +
            guides(color = "none") + 
            #guides(color = guide_legend(title = "", label = TRUE)) +
            facet_grid(Area~.) 
ggplotly(plot.esc) 
## Add line weight or line type based on increasing or decreasing trend in 2014.

```


```{r plot.escapement,  echo = FALSE}
suppressWarnings(ggplotly(plot.esc))  
```

**`r fig_nums("plot.esc", "Chinook Salmon escapement from rivers on East and West Coast of Vancouver Island.")`**


Well, that figure sucks. But it shows how variable escapement is between years. On the East Coast of the Island, abundance increased in 'r format(3/7*100, digits = 2)`% of plotted streams and decreased in all others. Decreases  

Relative to 2013, abundance in all plotted west coast streams was slightly reduced in 2014. There was a major crash in the Burnam River, but this is exaggerated by unusually high returns in 2013, 2015 and 2016. 

### MAYBE RERUN ESCAPEMENT PLOT USING ALL ESCPAEMENT DATA!? FACET BY AREA?

### ADD METRIC THAT STANDARDIZES ESCAPEMENT. E.G. total annual returns vs mean annual returns.

## Influence of river flow on catches
Last year there was a lot of speculation that high flows in the Campbell River may have caused fish to move directly into the river rather than staging in the pool. Let's look at flow in the Campbell River to see how 2022 flows compared to previous years. 

```{r plot3-4prep, include = FALSE}
    catch_data <- catch_data %>% mutate(Year = format(Date, '%Y'),
                                        Month = format(Date, '%m'),
                                        Weeknum = format(Date, '%V'))    

    flow.catch <- left_join(flow.data.tyee, catch_data, by = c("Year","Month","Weeknum","Date"))

    
    ## Reduce to past 5 years only.                          
    flow.catch <- flow.catch %>%  
                  mutate(catch_scaled    = catch_binary * 7, 
                         q.daily.scaled  = q.daily/20,
                         q.5yr.rm.scaled = q.5yr.roll.mean/20,
                         q.5y.rse.scaled = q.5y.roll.se/20,
                         date.std = case_when(year(Date) >= 0 ~ 'year<-'(Date, 2021),TRUE ~ Date)) ## Set all dates to same year
                                                
    
    flow.catch.2022 <- flow.catch %>% filter(between(date.std, as.Date("2021-07-15"), as.Date("2021-09-15")),
                                               Year  >= 2019,
                                               PARAM == 1)
    
    flow.catch.recent <- flow.catch %>% filter(between(date.std, as.Date("2021-07-15"), as.Date("2021-09-15")),
                                               Year >2006,
                                               PARAM == 1)
    
# Plot of # Tyee per day, relative to flow. From 2016 to 2022.
plot3 <-    ggplot(flow.catch.2022) +
                 geom_bar(aes(x = date.std, y = catch_scaled, fill = PARAM), stat= "identity", color = "Navy") +
                 geom_line(aes(x = date.std, y = q.daily, linetype = "dashed", color = "Daily")) +
                 geom_line(aes(x = date.std, y = q.5yr.roll.mean, linetype = "twodashed", color = "5-yr Mean")) +
                 geom_text(aes(x = as.Date("2021-07-20"), y = 10, label = str_c("Total Catch = ",catch_yr.total), size = 8))+
                 labs(x = "Date", y = "Discharge") +
                 scale_x_date(date_breaks = "5 days", date_labels = "%m-%d", minor_breaks = "1 day") +
                 scale_y_continuous(breaks = seq(0, 75, 13),
                                    sec.axis = sec_axis(~./7, name = "Number of Fish")) +  #scale secondary access by x25
                 guides(fill = guide_legend(title = "# Tyee", label = FALSE),
                        linetype = "none",
                        color = guide_legend(title = "Discharge (cms)", label = TRUE),
                        size = "none") +
                 facet_grid(Year~.) +
                 theme_bw() +
                 theme(legend.position = "bottom") 

#str(flow.catch.recent)
# Plot of # Tyee per day relative to flow, from 2002 to 2022.
plot4 <-    ggplot(flow.catch.recent) +
                 geom_bar(aes(x = date.std, y = catch_scaled, fill = PARAM), stat= "identity", color = "Navy") +
                 geom_line(aes(x = date.std, y = q.daily, linetype = "dashed", color = "Daily")) +
                 geom_line(aes(x = date.std, y = q.5yr.roll.mean, linetype = "twodashed", color = "5-yr Mean")) +
                 geom_text(aes(x = as.Date("2021-07-20"), y = 13, label = str_c("Total Catch = ",catch_yr.total), size = 8)) +
                 labs(x = "Date", y = "Discharge (cms)") +
                 scale_x_date(date_breaks = "5 days", date_labels = "%m-%d", minor_breaks = "1 day") +
                 scale_y_continuous(breaks = seq(0, 130, 10),
                                    sec.axis = sec_axis(~./7, name = "Number of Fish")) +  #scale secondary access by x25
                 guides(fill = guide_legend(title = "# Tyee", label = FALSE),
                        linetype = "none",
                        color = guide_legend(title = "Discharge (cms)", label = TRUE),
                        size = "none") +
                 facet_grid(Year~.) +
                 theme_bw() +
                 theme(legend.position = "bottom")  

```


```{r plot3print,  echo = FALSE}
suppressWarnings(print(plot3))  
```

**`r fig_nums("plot3", "Catches of Tyee Salmon since 2016 relative to flow in the Campebll River.")`**


Well, it's clear that flows in 2022 were higher than past years and higher than mean flows over the past 5-years. But this doesn't mean that is why fewer fish were captured. Either way let's take a closer look at the correlation between flow and capture.

```{r prepare scatter plot, include = FALSE}
## Scatter plots examining relationship between flow and number of fish captured.

flow.catch.scatter <- flow.catch %>% filter(catch_binary == 1) %>%
                                     group_by(format(q.daily, digits = 1)) %>%
                                     mutate(total.catch = sum(catch_binary),
                                            total.catch.ln = log(total.catch),
                                            q.daily.ln     = log(q.daily)) 
library(scales)
plot5 <- ggplot(flow.catch.scatter, aes(x=q.daily, y = total.catch)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 35)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

summary(flow.catch.scatter$total.catch.ln) #1-5
summary(flow.catch.scatter$q.daily.ln) #3-5

## Use this!
plot5.1 <- ggplot(flow.catch.scatter, aes(x=q.daily.ln, y = total.catch)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Log Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()


plot5.2 <- ggplot(flow.catch.scatter, aes(x=q.daily, y = total.catch.ln)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

plot5.3 <- ggplot(flow.catch.scatter, aes(x=q.daily.ln, y = total.catch.ln)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

```

```{r, echo=FALSE}
suppressWarnings(print(plot5))
```

`r fig_nums("plot5", "Relationship between river flow and fish capture")`

`r fig_nums("plot5", display = "cite")` shows a strong negative relationship between discharge and the number of fish that are captured. This is what you would expect, that fish will hold in the pool while flows are low and that they will move into the river when flows are higher and they can safely navigate upstream. However, the fishery occurs during the late summer, when flows are typically low and it is possible that the timing of the fishery has contributed to observed trends. 

OK, well there is a relationship (that could be due to a number of things). Lets have a look at some of the older data. 

```{r plot_flow,  fig.dim = c(8,30), echo=FALSE}
suppressWarnings(print(plot4))
```

`r fig_nums("plot4", "Catches of Tyee Salmon since 2007 relative to flow in the Campebll River.")`



Let's look at commercial catches. Maybe there is a fishery that could be intercepting a large number of Tyees.

```{r}
can.catch <- comm.catch %>% rename(Catch.Type = 'Catch Type',
                                   Data.Type  = 'Data Type') %>%
                            mutate(Area         = as.factor(Area),
                                   Species      = as.factor(Species),
                                   Year         = as.numeric(Year),
                                   Catch.Type = as.factor(Catch.Type)) %>%
                            filter(Country   ==  "Canada",
                                   Year      >= 1997,
                                   Data.Type == "Number (000's)")

can.catch.cn <- can.catch %>% filter(Species   == "Chinook",
                                     Area      == "Whole country")

      CN.catch.plot <- ggplot(can.catch.cn) +
                              geom_line(aes(x = Year, y = Total.Catch, color = Catch.Type)) +
                       labs(x = "Year", y = "Total Catch (0000's of fish") +
                       theme_bw()
      
      CN.catch.plot

can.catch.cn2 <- can.catch %>% filter(Species   == "Chinook",
                                      Catch.Type == "Sport")
      summary(can.catch.cn2)

      CN.catch.plot2 <- ggplot(can.catch.cn2) +
                              geom_line(aes(x = Year, y = Total.Catch, color = Area)) +
                                   labs(x = "Year", y = "Total Catch (0000's of fish") +
                                   theme_bw()
      CN.catch.plot2

      

can.catch.sk <- can.catch %>% filter(Species   == "Sockeye")

colnames
summary(can.catch.cn2)


CN.catch.plot

sk.catch.plot <- ggplot(can.catch.sk) +
                        geom_line(aes(x = Year, y = Total.Catch, color = Species, linetype = Catch.Type))
sk.catch.plot

```


###Notes
Plot peak flows 4 to 5 years previous (e.g. impact of peak flows on recruitment).
- Assume mortality at >200 cms
- spawning habitat lost at 300-400 cms
- Is Quinsam flow regulated? Ask Mary. 

Is return age genetic? Or environmental? 




### Supplemental Tables and Figures
```{r table2prep, include = FALSE}
# Table of size by age class and sex.
age_table2 <- age_data %>% select(Waterbody, Sex, Age, n, Perc.Total.by.Sex, Perc.Total.by.Stream, bin_range, meanFL, SE)


table2 <- knitr::kable(age_table2, col.names = c("Waterbody","Sex", "Age", "n", "% of Total <br>(by Sex)", "% of Total <br>(by Stream)", "Size Range <br>(mm)", "Mean Lenght <br>(mm)", "Std. Error"),
             digits = 2,  align=rep('c', 5),
             caption = "Table 1. Size at age of male and female Chinook Salmon captured in Campbell River watershed")
```


```{r, echo = FALSE}
table2
```



