---
title: "GitTyee"
author: "Eric V"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: true
    code_folding: "show"
---

A high-level look at trends in catches of Tyee salmon in Campbell River's legendary Tyee Pool. All data exploration is being completed for [fun](https://i.giphy.com/media/Cz6TlrRVVyv9S/giphy.webp) and to learn some new tools. There are far more technical ways of examining this data, but they aren't as fun. All results and interpretation are purely speculative. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Prepare Working Environment ----
## Clear workspace ##
rm(list = ls())  

## This code is to fix a bug in R 2023.06.0+421 <https://github.com/rstudio/rstudio/issues/13188>
options(rstudio.help.showDataPreview = FALSE)
getOption("rstudio.help.showDataPreview")

## Load Packages
    library(tidyverse)
    library(tidyr)
    library(dplyr)
    library(lubridate)
    library(reshape2)
    library(ggplot2)
    library(readxl)
    library(downloadthis)
    library(knitr)
    library(captioner)
    library(zoo)
    library(gridExtra)

## Define Working Directory ---
#setwd("C:/Users/evogt/R Analysis/EAV/Tyee/")

## Define Input Files
    #1. Catch Data
    catch.dat <- "Data/TyeeCatchData.xlsx"
    
    #2. Escapement Data
    esc.dat <- "Data/Area13Escapement.xlsx"
    
    #3. Flow Data
    q.dat <- "Data/CR_Discharge_1949-2023.xlsx" 
    
    #4. Age Class Data
    age.dat <- "Data/CR_AgeClass.xlsx"
    
    #5. Commercial Catch data
    comm.catch.dat <- "Data/NPAFC_CommercialCatch_21June2022.xlsx"

## Define Output Locations
    plot.output <- "Plots/"
    model.output <- "Output/"
    
##  Set up captioner package calls. 
  fig_nums   <- captioner(prefix = "Figure")  
  table_nums <- captioner(prefix = "Table")
    
##__________________________####    
## Load Data ---- 

##* 1. Prep Blank Date Data ---- 
    date_seq <- data.frame(Date = seq(ymd('2002-07-01'), ymd('2022-09-30'), by = 'days')) %>%
                mutate(Month = strftime(Date, format = "%m"),
                       Month = as.numeric(Month)) %>%
                filter(between(Month,7,9))

## * 2. Tyee Catch Data ----
    raw_catch  <- read_excel(catch.dat) # Date, time and size of capture

        ## Format Catch Data Dates ##
        raw_catch <- raw_catch %>% mutate(Date = as.Date(raw_catch$RawDate),
                                          catch_binary = 1) %>%
                                   group_by(Date) %>%
                                   summarise(catch_binary = sum(catch_binary))

        ## Merge with date_sequence
        catch_daily <- left_join(date_seq, raw_catch, by = "Date") %>%
                       mutate(catch_binary = coalesce(catch_binary, 0),  
                              Year = strftime(Date, format = "%Y"),
                              Year = as.numeric(Year),
                              Month = strftime(Date, format = "%m"),
                              Month = as.numeric(Month),
                              Weeknum      = strftime(Date, format = "%V"),
                              Weeknum = as.numeric(Weeknum),
                              catch_binary = coalesce(catch_binary, 0))  
      
        
        ## Calculate Yearly Catches
        catch_yearly <- catch_daily %>% 
                        group_by(Year) %>%
                        summarize(catch_yr.total = sum(catch_binary),
                                  catch_yr.mean  = mean(catch_binary)) %>%
                        ungroup %>%
                        mutate(catch_yrs.mean.total = mean(catch_yr.total),
                               catch_yrs.mean.catch = mean(catch_yr.mean),
                               tyee_cycle4 = as.numeric(rep(1:4, length.out = length(Year))),
                               tyee_cycle5 = as.numeric(rep(1:5, length.out = length(Year)))) 
                                          
        ## Calculate Weekly Catches
        catch_yrwk <- catch_daily %>% 
                      group_by(Year, Weeknum) %>%
                      summarize(catch_yrwk.total = sum(catch_binary)) 

        ## Calculate Weekly Catches
        catch_wk <- catch_daily %>% 
                    group_by(Weeknum) %>%
                    filter(between(Weeknum, 27, 39)) %>%
                    summarize(catch_wk.total = sum(catch_binary)) %>%
                    mutate(catch_wk.mean     = catch_wk.total/21) %>%         # 21 years data from 2002 to 2022
                    ungroup() %>%
                    mutate(catch_wks.mean = mean(catch_wk.mean))
        
         
        ## Merge Catch Data
        catch_dat <- left_join(catch_daily, catch_yearly, by = "Year")
        catch_dat <- left_join(catch_dat, catch_yrwk, by = c("Year", "Weeknum"))
        catch_data <- left_join(catch_dat, catch_wk, by = "Weeknum")

        colnames(catch_data)                               
 
## * 3. Escapement Data ----
        ## Load Data      
        esc_data <- read_excel(esc.dat)
        
        esc.dat2 <- filter(esc_data, ANALYSIS_YR > 2010)
    
        ## Prepare dataset for CR Escapement 
        cr_esc <- esc_data %>% filter(GAZETTED_NAME == "CAMPBELL RIVER",                 # only show data for CR
                                      #ANALYSIS_YR >=2002) %>% # data for same time period as tyee catch data
                                      ANALYSIS_YR >=1990) %>% # data from prior to tyee catch data so we can predict tyee returns.    
                               mutate(Year          =  as.numeric(ANALYSIS_YR),
                                     Waterbody      =  as.factor(GAZETTED_NAME),
                                     Esc_Count      =  as.numeric(MAX_ESTIMATE),
                                     Esc_Scaled     =  as.numeric(MAX_ESTIMATE/25),
                                     Esc_Mean       =  as.numeric(mean(MAX_ESTIMATE)),
                                     Esc_MeanScaled =  as.numeric(mean(MAX_ESTIMATE/25)),
                                     Species        =  as.factor(SPECIES)) %>%
                               select(Year, Waterbody, Species, Esc_Count, Esc_Scaled, Esc_Mean, Esc_MeanScaled)
        
        
        
## * 4. Flow Data (Tyee Season) ----
      ## Daily flow Data from 1949 to 2021
      flow_data <- read_excel(q.dat) 
          
      flow.data.all <- flow_data %>% 
                              mutate(Season   
                                        = case_when(
                                              Month >=1 & Month <= 3 ~ "Winter",
                                              Month >=4 & Month <= 6 ~ "Spring",
                                              Month >=7 & Month <= 8 ~ "Summer",
                                              Month >=9 & Month <= 10 ~ "Fall",
                                              Month >=11 & Month <= 12 ~ "Winter")) %>%
                              group_by(Year, Season) %>%
                              mutate(q.peak.season.yr = max(Value),
                                     test.data = as.numeric(1))   

    ## Flow Data Through Tyee Season(July 1 to Sept 30. 2000 to 2022)
      str(flow.data.all)

    flow.data.tyee <- flow.data.all %>% 
                        filter(between(Month,7,9)) %>%
                        mutate(q.daily         = as.numeric(Value),
                               Date            = as.Date(Date),
                               Year            = format(Date, '%Y'),
                               Month           = format(Date, '%m'),
                               Weeknum         = format(Date, format = "%V")) %>%
                        group_by(Year) %>% 
                              mutate(q.yr.mean  = mean(Value, na.rm = TRUE),
                                     q.yr.se = sd(Value, na.rm = TRUE)/sqrt(n())) %>% 
                        ungroup() %>%
                                           
                        group_by(Month) %>%                                              
                              mutate(q.m       = mean(Value, na.rm = TRUE),
                                     q.m.se    = sd(Value, na.rm = TRUE)/sqrt(n())) %>%
                              ungroup() %>%
                                         
                         group_by(Year, Month) %>% 
                              mutate(q.yrm     = mean(Value, na.rm = TRUE),
                                     q.yrm.se  = sd(Value, na.rm = TRUE)/sqrt(n())) %>%
                              ungroup() %>%
                   
                         group_by(Year, Weeknum) %>% 
                              mutate(q.yrwk     = mean(Value, na.rm = TRUE),
                                     q.yrwk.max = max(Value, na.rm = TRUE),
                                     q.yrwk.se  = sd(Value, na.rm = TRUE)/sqrt(n())) %>%
                              ungroup()   %>%      
 
                        group_by(Weeknum) %>%
                              mutate(q.wk       = mean(Value, na.rm = TRUE),
                                     q.wk.se    = sd(Value, na.rm = TRUE)/sqrt(n())) %>%
                              ungroup() %>%
                        mutate(q.5yr.roll.mean = rollmean(q.daily, k = 455, align = "right", fill=NA), # 5yr running flow
                               q.5y.roll.se    = rollapply(q.daily, width = 455, FUN = sd, align = "right", fill = NA)/sqrt(455)) %>%
                        filter(Year > 2001)

## 5. Add age data
    age_data <- read_excel(age.dat)
    
## 6. Salmon Catch Data
    comm.catch.dat <- read_excel(comm.catch.dat) 

    comm.catch <- comm.catch.dat %>% pivot_longer(cols = c(7:103),
                                                  names_to = "Year",
                                                  values_to = "Total.Catch",
                                                  values_drop_na = TRUE) %>%
                                      rename(Area = 'Reporting Area')
```

## The Data and what we know.

This analysis uses the following publicly available data:

1) Annual catch records from the [Tyee Club](https://www.tyeeclub.org/catch-records/>). 
2) Discharge data collected on the Campbell River by the [Water Survey of Canada](https://wateroffice.ec.gc.ca/index_e.html).
3) Annual Chinook Salmon escapement data available in the [DFO NuSEDS database](https://open.canada.ca/data/en/dataset/c48669a3-045b-400d-b730-48aafe8c5ee6).
4) Annual catch statistics from the [North Pacific Anadromous Fish Commission](https://npafc.org/statistics/)
5) Area based commercial catch statistics from DFO are [available from 2001 to 2016](https://www.pac.dfo-mpo.gc.ca/stats/smon/index-eng.html) 


This is certainly an interesting dataset, but it has its limitations. For example, there is no information on effort (# boats per day) and biological data is limited (e.g. size, girth and age of tyees or number of undersized fish captured). 

Information on Campbell River Chinook salmon is somewhat more available. For example, data collected by [Sturham et al. 1999](https://publications.gc.ca/collections/collection_2014/mpo-dfo/Fs97-4-2477-eng.pdf) suggests that a roughly equal proportion of spawners return to the Campbell River as age-4 and age-5 fish (Table 1 and Table 2), with age-4 fish ranging in size from 550-949 mm (mean ~ 780 mm) and age-5 fish ranging in size from 700-949 mm (mean ~ 840 mm). Age-6 fish were identified, accounted for less than 1% of all fish in the Campbell  (n = 1 fish, 930 mm) and Quinsam rivers. However, [Ewart & Anderson, 2013](http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf) report that the 2012 return was comprised of ~2% Age-3, ~37% Age 4 and 61% Age-5 fish and that female Chinook in the Campbell River carried roughly ~5,700 to 6,000 eggs (decreasing trend).

Juvenile Chinook Salmon in the Campbell River have been studied intensively since 2015 (e.g. [Thornton et al. 2022](https://www.bchydro.com/content/dam/BCHydro/customer-portal/documents/corporate/environment-sustainability/water-use-planning/vancouver-island/jhtmon-15-Yr-7-2022-07-25.pdf). These data suggests nearly all Campbell River Chinook out migrate as Age-0+ juveniles from March through July. Smaller recently emerged Age-0+ fry are dominant and typically captured from March through early May (37 to 52 m). Larger Age-0+ smolts are less common and move out from May through July (64 to 88 mm). Marine survival of unfed fry released from the Quinsam hatchery range from 0.2% to 0.4% (yes, that 0.002 to 0.004) ([Ewart & Anderson 2013]( http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf)).  

Spawner and redd surveys of the Campbell River canyon, where most Chinook Salmon spawn, have been completed bi-weekly throughout the spawning period since 2014 (e.g. Thornton et al. 2022). These data show that Chinook spawning occurs from late September through early November and peaks in mid-October and that spawners reside in the river for ~12 days. [Ewart & Anderson 2013]( http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf) report that 56% of the otoliths examined from the 2012 return showed no signs of hatchery marking and are assumed wild. The remaining 44% are presumed to have originated from instream incubators (31%), seapen released smolts (4%) and Quinsam River released smolts (9%). 

Estimates of juvenile Chinook production based on numbers of observed spawners have generally been less than numbers trapped throughout the outmigration period. which may be due to increased juvenile survival or inaccurate/coarse estimates of fecundity.        

For now, I have only looked at data back to 2002, as that is the limit of easily accessible Tyee catch data. 


```{r plot1_tyeecatch, echo = FALSE}
## Prepare Plot
plot1 <- ggplot(catch_data) +
                      geom_bar(aes(x= Year, y = catch_binary, fill = tyee_cycle4), stat = "identity") +
                      geom_hline(aes(yintercept=catch_yrs.mean.total, color = catch_yrs.mean.total), 
                                linetype = "dashed", linewidth = 0.5) +
                      labs(y = "# Tyee Salmon", x = "") +
                      guides(fill = "none", #guide_legend(title = "Tyee Cycle"),
                             color = guide_legend(title = "Mean catches per year", label = FALSE)) + 
                      scale_x_continuous(breaks = seq(2002,2023,2)) +
                      scale_y_continuous(breaks = seq(0, 100, 5)) +
                      theme_bw() +  
                      theme(legend.position = c(0.78, 0.88),
                            legend.box.background = element_rect(colour = "black", linewidth = 1.25, fill = NA)) 
```

```{r tyeecatch.plot, include = FALSE}
suppressWarnings(print(plot1)) 
```

```{r include=FALSE}
## Filter escapement data.... 
cr_esc2 <- cr_esc %>% filter(Year >=2002)

## Merge escapement data with tyee catch data
cr_data <- left_join(catch_data, cr_esc2, by = "Year")
    
cr_yearly <- cr_data %>% mutate(Year = as.numeric(Year)) %>%
                         group_by(Year) %>%
                         select(Year, catch_yr.total, catch_yr.mean, Esc_Scaled, Species, tyee_cycle4)
```

## Tyee Catches Relative to Escapement    
```{r plot2_CR_Esc, echo = FALSE}

## Prepare plot of # Tyee vs annual escapement.
plot2 <- ggplot(cr_data) +
                geom_bar(aes(x = Year, y = catch_binary, fill = tyee_cycle4), 
                              stat = "identity") +
                geom_line(aes(x = Year, y = Esc_Scaled, linetype = Species), 
                              color = "lightblue", linewidth = 1.2) +
                geom_hline(aes(yintercept = catch_yrs.mean.total, color = catch_yrs.mean.total), 
                              linetype = "dashed", linewidth = 0.5) +
                labs(x = "Year", y = "Number Tyee Captured") + 
                guides(fill =  "none", #guide_legend(title = "Tyee Cycle", label = FALSE),
                       linetype = guide_legend(title = "Escapement", label = FALSE),
                       color = guide_legend(title = "Mean Tyee Catch", label = FALSE)) +
                scale_y_continuous(breaks = seq(0, 100, 5),
                                    sec.axis = sec_axis(~.*25, name = "Escapement")) +  #scale secondary access by x25
                scale_x_continuous(breaks = seq(2002,2022,2)) +            
                theme_bw() +
                theme(legend.direction = "horizontal",
                      legend.position = "bottom")

```

```{r tyee vs escapement, echo=FALSE}
suppressWarnings(print(plot2))   
```

`r fig_nums("plot2", "Trends in Tyee Salmon captures and Campbell River Chinook Salmon escapement.")`


A quick look at `r fig_nums("plot2", display = "cite")` shows:

* There is a fairly clear 4-year cycle of relatively higher catches (highlighted with shading). Which is interesting, and raises lots of        questions...
* There has been a consistent decline in the number of Tyee salmon captured per year.
* There was a major crash or failure in 2014. 



If we look at Escapement trends presented in `r fig_nums("plot2", display = "cite")` , we can see:


1) There has been a general declining trend in escapement (consistent with regional trends),
2) Periods of increased escapement correspond with periods of increased Tyee catches, but not always (e.g. 2005, 2017 and 2020). Given the lack of information on effort (e.g. # of boats fishing per day) we cannot tease apart whether the lack of catches in some years is due to reduction in pressure. 
3) It is also possible that years with high escapement and low Tyee numbers were due to an increased proportion of smaller fish returning to the Campbell. Without annual information on age structure I cannot tease this apart.

```{r table1prep, include = FALSE}
## Prepare data for table
age_table1 <- age_data %>% select(Waterbody, Age, n, bin_min, bin_max, meanFL, SD, SE) %>%
                           #filter(Waterbody == "Campbell River") %>%
                           mutate(Age = as.factor(Age),
                                  meanFL = as.numeric(meanFL),
                                  bin_min = as.numeric(bin_min),
                                  bin_max = as.numeric(bin_max))

  age_table1 <- age_table1 %>% dplyr::group_by(Waterbody, Age) %>%
                                summarize(n = sum(n),
                                          bin_min = min(bin_min),
                                          bin_max = max(bin_max),
                                          mean = mean(meanFL)) %>%
                                mutate('% of Total' = prop.table(n)*100,
                                       size_range = paste(bin_min, "-", bin_max)) %>%
                                select(Waterbody, Age, n, '% of Total',size_range, mean, )
                                
  
table1 <- knitr::kable(age_table1, col.names = c("Waterbody", "Age", "n", "% of Total", "Size Range <br>(mm)", "Mean Lenght <br>(mm)"),
             digits = 1,  align=rep('c', 5),
             caption = "Table 1. Size at age of Chinook Salmon captured in Campbell River watershed from [Sturham et al. 1999](https://publications.gc.ca/collections/collection_2014/mpo-dfo/Fs97-4-2477-eng.pdf)")
```

```{r, echo = FALSE}
table1
```

## What could be affecting returns and catches?
At it's most basic level, there are three things that are likely affecting catches of Tyee salmon.


**1. Juvenile recruitment**

* This is determined by the number of eggs that are deposited (for easy math, lets say     females account for 50% of escapement, that each one deposits 4000 eggs and that egg to fry survival is 10%).     We will assume that fish that survive to fry will enter the sea. Hydrometric data on the Campbell is vailable back to 1949 and it is likely that extreme high or low flow events (e.g. greater than 300 cms, less than ??50 cms??) during the rearing/incubation period (maybe October to February) will reduce juvenile recruitment.

**2. Marine survival and productivity**

* This is way too complicated for right now. Let's feel warm and fuzzy by assuming survival and productivity are stable (side note, they arent!). But if we don't do this we can't assume that proportions calculated from Sturham et al. are representative of current returns (they likely are not, fish sizes are decreasing as water temperatures and pH increase, so there are likely fewer Tyee returning now than in previous years). 
  
**3. Fishing effort and catchability **

  * For now, I am going to assume effort (# of boats fishing per tide/day) is constant and that catchability (percent of Tyees present that are captured) are stable. In reality, effort has likely decreased over time (especially since 2014) and catchability has likely increased as peoples knowledge, skill and fishing technology have improved over time (not everyone though, I still suck). Either way, not much I am going to do with this.

**4. Fishing Conditions **
  * No question that fewer fish will be captured during seasons with poor fishing conditions (e.g. very windy, lots of rain). It is also possible that fish behaviour will change in response to river conditions. Certainly there was a lot of speculation that low catches in 2022 were due to high water levels (as evidenced by lowest catch on record while many very large fish were being captured in the river).  
  

**So, what can we look at? **Well, we could look at everything. But I am lazy, so let's just look at how many Tyee should return to the river each year and fishing conditions. We can estimate the number of Tyee salmon that should return to the Campbell River ***very crudely*** if we make some BIG assumptions: 
    + Fecundity of Campbell River Tyee salmon is ????4500??? eggs per female.
    + Sex ratios are 60:40 female to male (based on Sturham data for Campbell River)
    + Egg to fry survival is approximately XXXX (estimated from Thronton et al. 2022).
    + Tyee Salmon are over 900 mm. In the Campbell River, I will assume that 10% of Age-4 male adults, 15% of Age-5 spawners (both sexes), and        all Age-6 fish are 30+ lbs (this is **very** loosely based on Sturham data, but I have not seen raw tables so its an guestimate).
    

```{r how many fish should come back, include= FALSE}
## Define assumptions
      fecundity <- 5700 # typically around 6000 for CR, http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf
      perc.female <- 0.6  # 60% of fish are females
      egg.to.fry <- 0.1
      fry.to.smolt <- 0.2
      marine.surv <- 0.003 #marine survival reported as 0.002 to 0.004 by  http://www.crsalmonfoundation.ca/wp-content/uploads/2021/01/CRSF12BYchinreportfinal.pdf 
      male <- 0.4    # 40% of fish are male
      Age4 <- 0.447  # 44.7% of fish are Age-4
      Age5 <- 0.461  # 46.1% of fish are Age-5
      Age6 <- 0.013  #  1.3% of fish are Age-6
      Tyee.Age4m.prop   <- 0.15  # 10% of Age-4 males are Tyee - MADE UP NUMBER!
      Tyee.Age5mf.prop  <- 0.35 # 15% of all Age-5 fish are Tyee - MADE UP NUMBER!
      Tyee.Age6mf.prop  <- 1    # 100% of all Age-6 fish are Tyee - MADE UP NUMBER!
      
## Calculate Ratios
      ratio.Age4.tyee <- male * Age4 * Tyee.Age4m.prop # multiply this by annual escapement to calculate # Age-4 males that are tyees.
      ratio.Age5.tyee <- Age5 * Tyee.Age5mf.prop # multiply this by annual escapement to calculate # Age-5 fish that are tyees.
      ratio.Age5.tyee <- Age6 * Tyee.Age6mf.prop # multiply this by annual escapement to calculate # Age-5 fish that are tyees.
      summary(cr_esc$Esc_Count)
      colnames(cr_esc)
      str(cr_esc)
      
## Estimate number of fish predicted to return from each age class based on historic escapement.       
pred.fish <- cr_esc %>% mutate(pred.returns = Esc_Count * perc.female *fecundity *
                                              egg.to.fry * fry.to.smolt * marine.surv,  
                               Age4_Yr = Year+4,
                               Age4_returns = Age4*pred.returns,
                               Age4_tyee    = Age4_returns * male * Tyee.Age4m.prop,
                               Age5_Yr = Year+5,
                               Age5_returns = Age5*pred.returns,
                               Age5_tyee    = Age5_returns * Tyee.Age5mf.prop,
                               Age6_Yr = Year+6,
                               Age6_returns = Age6*pred.returns,
                               Age6_tyee    = Age6_returns * Tyee.Age6mf.prop)

## Estimate total number of Tyee expected to return in each year.
pred.tyee <- pred.fish %>% select(pred.returns,Age4_Yr, Age5_Yr,Age6_Yr,Age4_tyee,Age5_tyee,Age6_tyee) %>%
                                  pivot_longer(-pred.returns,
                                                names_to = c("Var", ".value"),
                                                names_sep = "_") %>%
                                  rename("Returning.AgeClass"   = "Var",
                                           "Year"               = "Yr",
                                           "Tyee.Total"         = "tyee") %>%
                                  group_by(Year) %>%
                                  summarize(Tyee.Total.Predicted = sum(Tyee.Total)) %>%
                                  mutate(Year = as.numeric(Year))
str(pred.fish)
str(pred.tyee)
## Join predicted fish database with estimate of total tyees per year
total.pred.tyee <- left_join(pred.fish, pred.tyee, by = c("Year")) %>%  
                   mutate(Tyee.Prop = Tyee.Total.Predicted/Esc_Count,
                          Tyee.Total.Predicted = coalesce(Tyee.Total.Predicted, 0)) ## Calculate proportion of Tyees relative to overall escapement


colnames(total.pred.tyee)
colnames(cr_data)

cr_data.yr <- cr_data %>% select(Year, tyee_cycle4, catch_binary, catch_yr.total,
                                 catch_yr.mean,catch_yrs.mean.total) 

cr_data.yr <- cr_data.yr %>% group_by(Year) %>%
                             summarize(tyee_cycle4   = mean(tyee_cycle4),
                                       catch_binary  = sum(catch_binary),
                                       catch_yr.total = mean(catch_yr.total),
                                       catch_yr.mean = mean(catch_yr.mean),
                                       catch_yrs.mean.total = mean(catch_yrs.mean.total)) %>%
                             mutate(Year = as.numeric(Year))


## Join Total PRedicted Tyee w. Summarized Tyee Catch data                                           
total.pred.tyee2 <- left_join(total.pred.tyee, cr_data.yr, by = "Year") %>% 
                                       filter(Year >2001)  

summary(total.pred.tyee$Tyee.Total.Predicted)

#tyee_cycle4 = as.numeric(rep(1:4, length.out = length(Year))
## need cr_data 
str(total.pred.tyee2)
plot66 <- ggplot(total.pred.tyee2) +
                 geom_bar(aes(x = Year, y = catch_yr.total, alpha = 0.3, fill = 'Total Tyee Catch'), 
                               stat = "identity") +
                 geom_bar(aes(x = Year, y = Tyee.Total.Predicted, alpha = 0.3, fill = 'Predicted Tyee Returns'), 
                              stat = 'identity') +
                # geom_bar(aes(x = Year, y = catch_yr.total, fill = tyee_cycle4, alpha = 0.8), 
                #                stat = "identity") +
                # geom_bar(aes(x = Year, y = Tyee.Total.Predicted, fill = 'Total Predicted Tyee', alpha = 0.3), 
                #               stat = 'identity') +
                geom_line(aes(x = Year, y = Esc_Scaled, linetype = Species), 
                              color = "lightblue", linewidth = 1.2) +
                geom_hline(aes(yintercept = catch_yrs.mean.total, color = catch_yrs.mean.total), 
                              linetype = "dashed", linewidth = 0.5) +
                labs(x = "", y = "Number Tyee Captured") + 
                guides(fill =  guide_legend(title = "", label = TRUE),
                       linetype = guide_legend(title = "Escapement", label = FALSE),
                       color = guide_legend(title = "Mean Tyee Catch", label = FALSE),
                       alpha = "none") +
                scale_y_continuous(breaks = seq(0, 100, 5),
                                    sec.axis = sec_axis(~.*25, name = "Escapement")) +  #scale secondary access by x25
                scale_x_continuous(breaks = seq(2002,2022,2)) +            
                theme_bw() +
                theme(legend.direction = "horizontal",
                      legend.position = "bottom")

plot66
```
```{r plot.predictred.returns,  echo = FALSE}
suppressWarnings(print(plot66))  
```

`r fig_nums("plot66", "Comparison of catches of Tyee Salmon, predicted returns of Tyee Salmon and annual Chinook Salmon escapement counts.")`

Well this is interesting!

1) There is a fairly drastic shift in predicted returns that coincides with the crash in 2014. Prior to the crash, predicted returns are consistently underestimated (`(8/11)*100`% of years are less than actual catches) whereas after the crash predicted Tyee returns are greater than total tyee catches in all but one year. 

A couple of things to keep in mind when trying to understand what this means.

      +   We should assume that only a proportion of all returning Tyees are captured each year. If all Tyee salmon were captured each               year, we would be actively selecting against large fish and it would be reasonable to expect to see a continuous decline in the            total number of Tyees returning each year. So, based on this logic (and my personal observation of tyees on the spawning ground),           the predicted Tyee returns should always be greater than total catches.  
      +   The formula and values used to estimate predicted returns of tyee salmon do not change. If we assume there is no change in                 catchability and that the number of Tyees captured in the pool is a representation of the number of tyees that return to the               river there appears to have been a dramatic reduction in the number of Tyee salmon in 2014. This aligns with escapement data,              which is also greatly reduced.
      +   Additionally, the figure shows that my formula and estimates are way off - which is not surprising as they were very crude!                This is most apparent in the years prior to the 2014 crash, but suggests predictions after the crash are also off too.     
      
So, what happened in 2014!? Did runs crash everywhere?

```{r, escapement comparison, include=FALSE}
unique(esc_data$GAZETTED_NAME)
esc.plot.dat <- esc_data %>% filter(GAZETTED_NAME %in% c("ARTLISH RIVER","BEDWELL RIVER", "BURMAN RIVER", "COWICHAN RIVER", 
                                                     "ENGLISHMAN RIVER","GOLD RIVER", "LITTLE QUALICUM RIVER","NIMPKISH RIVER", 
                                                     "PHILLIPS RIVER", "QUALICUM RIVER", "QUINSAM RIVER", "SALMON RIVER", 
                                                     "WANNOCK RIVER")) %>% 
                          mutate(Year = as.numeric(ANALYSIS_YR),
                                 Stream = as.factor(GAZETTED_NAME),
                                 Area   = recode(as.factor(GAZETTED_NAME),
                                                 'ARTLISH RIVER'         = "West Coast VI", 
                                                 'BEDWELL RIVER'         = "West Coast VI",
                                                 'BURMAN RIVER'          = "West Coast VI",
                                                 'GOLD RIVER'            = "West Coast VI",
                                                 'COWICHAN RIVER'        = "East Coast VI",
                                                 'ENGLISHMAN RIVER'      = "East Coast VI", 
                                                 'LITTLE QUALICUM RIVER' = "East Coast VI",
                                                 'NIMPKISH RIVER'        = "East Coast VI",
                                                 'QUALICUM RIVER'        = "East Coast VI",
                                                 'QUINSAM RIVER'         = "East Coast VI",
                                                 'SALMON RIVER'          = "East Coast VI",
                                                 'PHILLIPS RIVER'        = "Mainland Coast",
                                                 'WANNOCK RIVER'          = "Mainland Coast")) %>%
                          group_by(Area, Stream, Year) %>%
                          summarize(Count =sum(MAX_ESTIMATE)) %>%
                          filter (Year > 2000)



str(esc.plot.dat)
plot.esc <- ggplot(esc.plot.dat, aes(x= Year, y = Count))+
            geom_line(aes(color = Stream), linewidth = 0.8) +
            labs(x = "", y = "# Spawning Chinook") +
            scale_x_continuous(breaks = c(2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016, 2018, 2020)) +
            theme_bw() +
            theme(legend.position = "bottom") +
            facet_grid(Area~.) 
plot.esc

#do.call(grid.arrange, plot.esc)
## Add line weight or line type based on increasing or decreasing trend in 2014.

```
```{r plot.escapement,  echo = FALSE}
suppressWarnings(print(plot.esc))  
```

`r fig_nums("plot.esc", "Chinook Salmon escapement from rivers on mainland coast as well as on East and West Coast of Vancouver Island.")`





## Influence of river flow on catches
Last year there was a lot of speculation that high flows in the Campbell River may have caused fish to move directly into the river rather than staging in the pool. Let's look at flow in the Campbell River to see how 2022 flows compared to previous years. 

```{r plot3-4prep, include = FALSE}
    catch_data <- catch_data %>% mutate(Year = format(Date, '%Y'),
                                        Month = format(Date, '%m'),
                                        Weeknum = format(Date, '%V'))    

    flow.catch <- left_join(flow.data.tyee, catch_data, by = c("Year","Month","Weeknum","Date"))

    
    ## Reduce to past 5 years only.                          
    flow.catch <- flow.catch %>%  
                  mutate(catch_scaled    = catch_binary * 7, 
                         q.daily.scaled  = q.daily/20,
                         q.5yr.rm.scaled = q.5yr.roll.mean/20,
                         q.5y.rse.scaled = q.5y.roll.se/20,
                         date.std = case_when(year(Date) >= 0 ~ 'year<-'(Date, 2021),TRUE ~ Date)) ## Set all dates to same year
                                                
    
    flow.catch.2022 <- flow.catch %>% filter(between(date.std, as.Date("2021-07-15"), as.Date("2021-09-15")),
                                               Year  >= 2019,
                                               PARAM == 1)
    
    flow.catch.recent <- flow.catch %>% filter(between(date.std, as.Date("2021-07-15"), as.Date("2021-09-15")),
                                               Year >2006,
                                               PARAM == 1)

plot3 <-    ggplot(flow.catch.2022) +
                 geom_bar(aes(x = date.std, y = catch_scaled, fill = PARAM), stat= "identity", color = "Navy") +
                 geom_line(aes(x = date.std, y = q.daily, linetype = "dashed", color = "Daily")) +
                 geom_line(aes(x = date.std, y = q.5yr.roll.mean, linetype = "twodashed", color = "5-yr Mean")) +
                 geom_text(aes(x = as.Date("2021-07-20"), y = 10, label = str_c("Total Catch = ",catch_yr.total), size = 8)) +
                 labs(x = "Date", y = "Discharge") +
                 scale_x_date(date_breaks = "5 days", date_labels = "%m-%d", minor_breaks = "1 day") +
                 scale_y_continuous(breaks = seq(0, 75, 13),
                                    sec.axis = sec_axis(~./7, name = "Number of Fish")) +  #scale secondary access by x25
                 guides(fill = guide_legend(title = "# Tyee", label = FALSE),
                        linetype = "none",
                        color = guide_legend(title = "Discharge (cms)", label = TRUE),
                        size = "none") +
                 facet_grid(Year~.) +
                 theme_bw() +
                 theme(legend.position = "bottom") 
str(flow.catch.recent)
plot4 <-    ggplot(flow.catch.recent) +
                 geom_bar(aes(x = date.std, y = catch_scaled, fill = PARAM), stat= "identity", color = "Navy") +
                 geom_line(aes(x = date.std, y = q.daily, linetype = "dashed", color = "Daily")) +
                 geom_line(aes(x = date.std, y = q.5yr.roll.mean, linetype = "twodashed", color = "5-yr Mean")) +
                 geom_text(aes(x = as.Date("2021-07-20"), y = 13, label = str_c("Total Catch = ",catch_yr.total), size = 8)) +
                 labs(x = "Date", y = "Discharge (cms)") +
                 scale_x_date(date_breaks = "5 days", date_labels = "%m-%d", minor_breaks = "1 day") +
                 scale_y_continuous(breaks = seq(0, 130, 10),
                                    sec.axis = sec_axis(~./7, name = "Number of Fish")) +  #scale secondary access by x25
                 guides(fill = guide_legend(title = "# Tyee", label = FALSE),
                        linetype = "none",
                        color = guide_legend(title = "Discharge (cms)", label = TRUE),
                        size = "none") +
                 facet_grid(Year~.) +
                 theme_bw() +
                 theme(legend.position = "bottom")  


```


```{r plot3print,  echo = FALSE}
suppressWarnings(print(plot3))  
```

`r fig_nums("plot3", "Catches of Tyee Salmon since 2016 relative to flow in the Campebll River.")`


Well, it's clear that flows in 2022 were higher than past years and higher than mean flows over the past 5-years. But this doesn't mean that is why fewer fish were captured but let's take a closer look at the correlation between flow and capture.

```{r prepare scatter plot, include = FALSE}
flow.catch.scatter <- flow.catch %>% filter(catch_binary == 1) %>%
                                     group_by(format(q.daily, digits = 1)) %>%
                                     mutate(total.catch = sum(catch_binary),
                                            total.catch.ln = log(total.catch),
                                            q.daily.ln     = log(q.daily)) 
library(scales)
plot5 <- ggplot(flow.catch.scatter, aes(x=q.daily, y = total.catch)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 35)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

summary(flow.catch.scatter$total.catch.ln) #1-5
summary(flow.catch.scatter$q.daily.ln) #3-5

## Use this!
plot5.1 <- ggplot(flow.catch.scatter, aes(x=q.daily.ln, y = total.catch)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Log Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()


plot5.2 <- ggplot(flow.catch.scatter, aes(x=q.daily, y = total.catch.ln)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

plot5.3 <- ggplot(flow.catch.scatter, aes(x=q.daily.ln, y = total.catch.ln)) +
                      geom_point() +
                      geom_smooth()+ #method = lm) +
                      scale_y_continuous(limits= c(0, 5)) +
                      labs(x = "Discharge (cms)", y = "Number of Tyee Captured") +
                      theme_bw()

```

```{r, echo=FALSE}
suppressWarnings(print(plot5))
```

`r fig_nums("plot5", "Relationship between river flow and fish capture")`

`r fig_nums("plot5", display = "cite")` shows a strong negative relationship between discharge and the number of fish that are captured. This is what you would expect, that fish will hold in the pool while flows are low and that they will move into the river when flows are higher and they can safely navigate upstream. However, the fishery occurs during the late summer, when flows are typically low and it is possible that the timing of the fishery has contributed to observed trends. 

OK, well there is a relationship (that could be due to a number of things). Lets have a look at some of the older data. 

```{r plot_flow,  fig.dim = c(8,30), echo=FALSE}
suppressWarnings(print(plot4))
```

`r fig_nums("plot4", "Catches of Tyee Salmon since 2007 relative to flow in the Campebll River.")`


  
Let's look at commercial catches. Maybe there is a fishery that could be intercepting a large number of Tyees.

```{r}
can.catch <- comm.catch %>% rename(Catch.Type = 'Catch Type',
                                   Data.Type  = 'Data Type') %>%
                            mutate(Area         = as.factor(Area),
                                   Species      = as.factor(Species),
                                   Year         = as.numeric(Year),
                                   Catch.Type = as.factor(Catch.Type)) %>%
                            filter(Country   ==  "Canada",
                                   Year      >= 1997,
                                   Data.Type == "Number (000's)")

can.catch.cn <- can.catch %>% filter(Species   == "Chinook",
                                     Area      == "Whole country")

      CN.catch.plot <- ggplot(can.catch.cn) +
                              geom_line(aes(x = Year, y = Total.Catch, color = Catch.Type)) +
                       labs(x = "Year", y = "Total Catch (0000's of fish") +
                       theme_bw()
      
      CN.catch.plot

can.catch.cn2 <- can.catch %>% filter(Species   == "Chinook",
                                      Catch.Type == "Sport")
      summary(can.catch.cn2)

      CN.catch.plot2 <- ggplot(can.catch.cn2) +
                              geom_line(aes(x = Year, y = Total.Catch, color = Area)) +
                                   labs(x = "Year", y = "Total Catch (0000's of fish") +
                                   theme_bw()
      CN.catch.plot2

      

can.catch.sk <- can.catch %>% filter(Species   == "Sockeye")

colnames
summary(can.catch.cn2)


CN.catch.plot

sk.catch.plot <- ggplot(can.catch.sk) +
                        geom_line(aes(x = Year, y = Total.Catch, color = Species, linetype = Catch.Type))
sk.catch.plot

```


###Notes
Plot peak flows 4 to 5 years previous (e.g. impact of peak flows on recruitment).
- Assume mortality at >200 cms
- spawning habitat lost at 300-400 cms
- Is Quinsam flow regulated? Ask Mary. 

Is return age genetic? Or environmental? 




### Supplemental Tables and Figures
```{r table2prep, include = FALSE}
# Table of size by age class and sex.
age_table2 <- age_data %>% select(Waterbody, Sex, Age, n, Perc.Total.by.Sex, Perc.Total.by.Stream, bin_range, meanFL, SE)


table2 <- knitr::kable(age_table2, col.names = c("Waterbody","Sex", "Age", "n", "% of Total <br>(by Sex)", "% of Total <br>(by Stream)", "Size Range <br>(mm)", "Mean Lenght <br>(mm)", "Std. Error"),
             digits = 2,  align=rep('c', 5),
             caption = "Table 1. Size at age of male and female Chinook Salmon captured in Campbell River watershed")
```


```{r, echo = FALSE}
table2
```



